---
phase: 05-wizard-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - public/js/wizard.js
  - public/js/wizardState.js
  - public/js/script.js
  - views/index.ejs
autonomous: true

must_haves:
  truths:
    - "Only one form section is visible at a time -- all other sections are display:none"
    - "Clicking Weiter advances to the next step, clicking Zuruck goes to the previous step"
    - "The URL hash updates to #step-N on each navigation and the browser back button navigates between steps"
    - "All entered data persists in sessionStorage after every field change and step transition"
    - "On page refresh (F5), the wizard restores to the last active step with all form fields repopulated"
    - "KfW-dependent wall and lueftung options re-render correctly after state restoration"
  artifacts:
    - path: "public/js/wizard.js"
      provides: "Wizard controller -- WIZARD_STEPS config, goToStep, wizardNext/wizardBack, validateCurrentStep, insertWizardNavigation, initWizard"
      min_lines: 120
    - path: "public/js/wizardState.js"
      provides: "sessionStorage persistence -- save, load, restore, clear functions"
      min_lines: 50
    - path: "public/js/script.js"
      provides: "Refactored -- scroll spy and smooth scroll disabled, wizard-compatible initialization"
    - path: "views/index.ejs"
      provides: "Script tags for wizard.js and wizardState.js, data-wizard-step attributes on sections"
  key_links:
    - from: "public/js/wizard.js"
      to: "public/js/wizardState.js"
      via: "WizardState.save(), WizardState.restore(), WizardState.clear()"
      pattern: "WizardState\\.(save|restore|clear)"
    - from: "public/js/wizard.js"
      to: "public/js/script.js"
      via: "Calls existing updateWallOptions(), updateLueftungOptions(), handleRadioSelect() after state restore"
      pattern: "updateWallOptions|updateLueftungOptions|handleRadioSelect"
    - from: "views/index.ejs"
      to: "public/js/wizard.js"
      via: "Script tag loads wizard.js which auto-initializes on DOMContentLoaded"
      pattern: "script src.*wizard\\.js"
---

<objective>
Create the wizard's JavaScript architecture: the step controller (wizard.js), sessionStorage state management (wizardState.js), and refactor script.js to disable scroll-based features that conflict with wizard navigation.

Purpose: This is the foundation for the entire wizard UI. Without the step machine, state persistence, and navigation, no other wizard work can proceed.

Output: Two new JS files (wizard.js, wizardState.js), a refactored script.js, and updated index.ejs with script tags and data attributes.
</objective>

<execution_context>
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-wizard-ui/05-RESEARCH.md

Key existing files:
@public/js/script.js — 597 lines, contains updateWallOptions(), updateLueftungOptions(), handleRadioSelect(), addRoom(), addEigenleistung(), initScrollSpy(), initSmoothScroll(), updateProgress(), initFormValidation(), initRadioCards(), initInlineValidation()
@views/index.ejs — 529 lines, 17 sections (section-1 through section-17), progress bar with 16 steps, form id="konfigurator-form"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create wizardState.js (sessionStorage persistence) and wizard.js (step controller)</name>
  <files>public/js/wizardState.js, public/js/wizard.js</files>
  <action>
  **Create `public/js/wizardState.js`:**

  A self-contained module (global `WizardState` object) for sessionStorage persistence:

  - `STATE_KEY = 'konfigurator-wizard'`
  - `save()`: Read all form fields from `document.getElementById('konfigurator-form')` using `new FormData(form).entries()`. Serialize into JSON object with key=field name, value=field value. Handle multi-value fields (eg_rooms, eg_details, og_rooms, og_details, ug_rooms, ug_details, eigenleistungen) by collecting into arrays. Also store `step: getCurrentStep()` (read from `window.__wizardCurrentStep` or parse from `location.hash`). Write to `sessionStorage.setItem(STATE_KEY, JSON.stringify(state))`.
  - `load()`: Parse and return sessionStorage item, or null.
  - `clear()`: Remove the item from sessionStorage.
  - `restore()`: Load state. If null, return false. Otherwise:
    1. Restore text inputs, selects, textareas by setting `.value`
    2. Restore radio buttons by setting `.checked = true` and dispatching a `change` event to trigger `handleRadioSelect()` visual updates
    3. For multi-value fields (rooms, eigenleistungen): count how many additional rows are needed beyond the default 1 row, call `addRoom('eg')` / `addRoom('og')` / `addRoom('ug')` / `addEigenleistung()` for each additional row, THEN fill in the values in order
    4. Return `state.step || 1` (the step number to navigate to)
  - Handle edge case: `bauherr_anrede` is a `<select>`, not radio. Set via `selectEl.value = state.bauherr_anrede`.
  - Handle edge case: `personenanzahl` is a `<select>`. Set via `selectEl.value = state.personenanzahl`.

  **Create `public/js/wizard.js`:**

  A self-contained wizard controller (all functions global for onclick access):

  1. **WIZARD_STEPS array** (17 entries):
     ```
     { step: 1,  id: 'section-1',  label: 'Kontakt',    required: ['bauherr_anrede', 'bauherr_vorname', 'bauherr_nachname'] },
     { step: 2,  id: 'section-2',  label: 'Haustyp',     required: ['haustyp'] },
     { step: 3,  id: 'section-3',  label: 'Energie',     required: ['kfw_standard'] },
     { step: 4,  id: 'section-4',  label: 'Wand',        required: ['wall'] },
     { step: 5,  id: 'section-5',  label: 'Innen',       required: ['innerwall'] },
     { step: 6,  id: 'section-6',  label: 'Decke',       required: ['decke'] },
     { step: 7,  id: 'section-7',  label: 'Fenster',     required: ['window'] },
     { step: 8,  id: 'section-8',  label: 'Dachform',    required: ['dach'] },
     { step: 9,  id: 'section-9',  label: 'Dach',        required: ['tiles'] },
     { step: 10, id: 'section-10', label: 'Treppe',      required: ['treppe'] },
     { step: 11, id: 'section-11', label: 'Heizung',     required: ['heizung'] },
     { step: 12, id: 'section-12', label: 'Luft',        required: ['lueftung'] },
     { step: 13, id: 'section-13', label: 'Personen',    required: ['personenanzahl'] },
     { step: 14, id: 'section-14', label: 'Grundst.',    required: ['grundstueck'] },
     { step: 15, id: 'section-15', label: 'Raume',       required: [] },
     { step: 16, id: 'section-16', label: 'Eigen',       required: [] },
     { step: 17, id: 'section-17', label: 'Berater',     required: [] },
     ```

  2. **`window.__wizardCurrentStep`** — tracks the current step number (used by wizardState.js).

  3. **`goToStep(stepNumber)`:**
     - Save current state: `WizardState.save()`
     - Hide all `.form-section` elements: set `display = 'none'`
     - Show the target section: set `display = 'block'`
     - Update `window.__wizardCurrentStep = stepNumber`
     - Update URL hash: `history.pushState(null, '', '#step-' + stepNumber)` (use pushState, not replaceState, so browser back button creates history entries)
     - Update progress bar: call `updateWizardProgress(stepNumber)`
     - Scroll to top: `window.scrollTo({ top: 0, behavior: 'instant' })` (instant, not smooth -- wizard transitions should feel snappy)

  4. **`updateWizardProgress(currentStep)`:**
     - For each `.progress-step[data-step]` element:
       - If step < currentStep AND the step's required fields are all filled: add class `completed`, remove `active`
       - If step === currentStep: add class `active`, remove `completed`
       - Otherwise: remove both `active` and `completed`
     - Update the progress bar fill width: `progressBar.style.width = (completedCount / WIZARD_STEPS.length * 100) + '%'`

  5. **`validateCurrentStep(stepNumber)`:**
     - Get `WIZARD_STEPS[stepNumber - 1].required`
     - For each required field name:
       - If type is radio: check `document.querySelector('[name="FIELD"]:checked')`. If not found, show error.
       - If type is select: check `.value !== ''`. If empty, show error.
       - If type is text/email/tel: check `.value.trim() !== ''`. If empty, show error.
     - Show errors inline: find or create a `.wizard-field-error` element near the field with the German message "Bitte treffen Sie eine Auswahl." for radio groups, "Bitte wahlen Sie eine Option." for selects, "Dieses Feld ist erforderlich." for text inputs.
     - Clear previous errors at the start of validation.
     - Scroll to the first error field within the visible section.
     - Return true if no errors, false otherwise.

  6. **`wizardNext()`:**
     - Call `validateCurrentStep(window.__wizardCurrentStep)`. If false, return.
     - If not on last step: `goToStep(window.__wizardCurrentStep + 1)`

  7. **`wizardBack()`:**
     - If not on first step: `goToStep(window.__wizardCurrentStep - 1)`

  8. **`insertWizardNavigation()`:**
     - For each WIZARD_STEPS entry, find the section by id.
     - Append a `<div class="wizard-nav">` at the bottom of each section with:
       - Zuruck button (hidden on step 1): `<button type="button" class="wizard-btn wizard-btn--back" onclick="wizardBack()">Zuruck</button>`
       - Step info: `<span class="wizard-step-info">Schritt N von 17</span>`
       - Weiter button (hidden on last step): `<button type="button" class="wizard-btn wizard-btn--next" onclick="wizardNext()">Weiter</button>`
       - On the LAST step (17): show the existing submit button area instead of Weiter. Do NOT add a second submit button.

  9. **`initWizard()`:**
     - Try restoring state: `const savedStep = WizardState.restore()`
     - If savedStep (truthy number):
       - Call `updateWallOptions()` and `updateLueftungOptions()` to re-render KfW-dependent options
       - After a 0ms setTimeout (to let DOM update from dynamic rendering), restore wall/lueftung radio selections from sessionStorage again (since the dynamic rendering cleared the containers)
       - Navigate: `goToStep(savedStep)`
     - Else: `goToStep(1)`
     - Add hashchange listener: parse `location.hash`, if matches `#step-N` where N is 1..17, call `goToStep(N)`
     - Add popstate listener for browser back button: same hash parsing
     - Add input/change listeners on the form for auto-save: `WizardState.save()` on every `input` and `change` event on `#konfigurator-form`
     - Call `insertWizardNavigation()`
     - Hide the existing `.submit-section` (it will be re-shown contextually on step 17)

  **CRITICAL sequence for state restoration:**
  The restore flow for KfW-dependent fields must be: (1) restore kfw_standard radio, (2) call updateWallOptions() + updateLueftungOptions() to rebuild dynamic HTML, (3) THEN in a setTimeout(0), re-read sessionStorage and re-select the wall/lueftung values within the newly rendered HTML.
  </action>
  <verify>
  - `public/js/wizard.js` exists and contains WIZARD_STEPS with 17 entries, goToStep, wizardNext, wizardBack, validateCurrentStep, insertWizardNavigation, initWizard
  - `public/js/wizardState.js` exists and contains STATE_KEY, save, load, restore, clear
  - Both files use vanilla JS (no imports, no require, no build tooling)
  - `npm start` succeeds without errors
  </verify>
  <done>wizard.js and wizardState.js exist with all required functions. Both are pure vanilla JS globals suitable for script tag loading.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor script.js and wire wizard into index.ejs</name>
  <files>public/js/script.js, views/index.ejs</files>
  <action>
  **Refactor `public/js/script.js`:**

  1. In the `DOMContentLoaded` handler (line ~583-596):
     - REMOVE the call to `initScrollSpy()`
     - REMOVE the call to `initSmoothScroll()`
     - REMOVE the generic input/select change/input listeners that call `updateProgress()` (lines 592-595) -- the wizard now controls progress tracking
     - KEEP: `initRadioCards()`, `initInlineValidation()`, `initFormValidation()`, `updateProgress()` (first call)
     - ADD at the end of DOMContentLoaded: `initWizard();` -- this calls the function defined in wizard.js

  2. Keep ALL existing functions intact:
     - `ToastNotification` class
     - `wallOptions` and `lueftungOptions` data
     - `updateWallOptions()` and `updateLueftungOptions()`
     - `handleRadioSelect(radio)`
     - `initRadioCards()`
     - `updateProgress()` -- still used by wizard for completion tracking
     - `initInlineValidation()` and `validateField()`
     - `addRoom(type)` and `addEigenleistung()`
     - `initFormValidation()` -- keep as-is; the wizard validation runs first, this is the last-resort guard

  3. In `updateWallOptions()` and `updateLueftungOptions()`, the dynamically generated radio card HTML includes `onchange="handleRadioSelect(this); updateProgress();"`. This is fine -- keep it. But also add `WizardState.save();` to the onchange so that dynamic option selections are persisted:
     - In updateWallOptions() template string, change `onchange="handleRadioSelect(this); updateProgress();"` to `onchange="handleRadioSelect(this); updateProgress(); if(typeof WizardState !== 'undefined') WizardState.save();"`
     - Same for updateLueftungOptions()

  **Update `views/index.ejs`:**

  1. Add `data-wizard-step="N"` attribute to each `<section class="form-section" id="section-N">` for all 17 sections. The N matches the section number. This is for semantic clarity and potential CSS targeting (the wizard uses the id attribute for actual show/hide).

  2. Add script tags BEFORE the existing `<script src="/js/script.js"></script>`:
     ```html
     <script src="/js/wizardState.js"></script>
     <script src="/js/wizard.js"></script>
     ```
     Order matters: wizardState.js must load before wizard.js (wizard.js calls WizardState), and both must load before script.js (script.js calls initWizard which is defined in wizard.js).

     WAIT -- actually script.js's DOMContentLoaded calls initWizard(). The load order of script tags does not matter as long as all scripts load before DOMContentLoaded fires. Since all three are synchronous scripts, they will load in order. So the correct order is:
     ```html
     <script src="/js/wizardState.js"></script>
     <script src="/js/wizard.js"></script>
     <script src="/js/script.js"></script>
     ```

  3. Hide the `.submit-section` initially with an inline style `style="display:none"` -- the wizard will reveal it contextually on the last step (or always leave it visible at the bottom, attached after section-17). Actually, the simpler approach: leave the submit section visible but only when on step 17. The wizard's `goToStep()` should handle showing/hiding the submit section based on whether we're on the last step. So in index.ejs, add `id="wizard-submit-section"` to the `.submit-section` div for easy targeting.

  4. Do NOT change the form `action="/submit"` or `method="POST"`. The submission flow stays as traditional form POST.
  </action>
  <verify>
  - Start the server with `npm start` (or `PORT=3001 npm start` to avoid conflicts)
  - Open browser to `http://localhost:3000/`
  - Verify: Only section 1 (Kontaktdaten) is visible
  - Verify: "Weiter" button appears at the bottom of section 1
  - Verify: Clicking "Weiter" without filling required fields shows German error messages
  - Verify: Filling Anrede + Vorname + Nachname and clicking "Weiter" advances to step 2 (Haustyp)
  - Verify: "Zuruck" button appears on step 2
  - Verify: URL shows `#step-2`
  - Verify: Browser back button returns to step 1
  - Verify: Fill steps 1-3, refresh page (F5) -- wizard restores to step 3 with fields populated
  - Verify: After selecting KFW55 in step 3, refresh -- step 4 (Wand) shows the correct wall options
  - Verify: Progress bar updates as steps are completed
  </verify>
  <done>The wizard is functional: single-step visibility, forward/back navigation with validation, URL hash history, sessionStorage persistence with correct KfW-dependent option restoration. All existing form functionality (addRoom, addEigenleistung, KfW filtering) works within the wizard context.</done>
</task>

</tasks>

<verification>
1. Server starts without errors: `npm start`
2. Opening `/` shows only step 1 with navigation buttons
3. Stepping through all 17 steps works with Weiter/Zuruck
4. Refreshing at any step restores state and returns to that step
5. Browser back button navigates between visited steps
6. Required field validation blocks advancement with German error messages
7. Dynamic KfW-dependent options (wall, lueftung) work correctly after state restore
8. The form submits successfully from step 17 (traditional POST to /submit)
9. The submit button is visible/accessible on step 17
</verification>

<success_criteria>
- wizard.js provides a working step machine with 17 steps, forward/back navigation, per-step validation, and URL hash history
- wizardState.js persists all form data to sessionStorage and restores it including multi-value fields (rooms, eigenleistungen)
- script.js is refactored to disable scroll spy and integrate wizard initialization
- index.ejs loads all three JS files in the correct order
- No new npm dependencies introduced
</success_criteria>

<output>
After completion, create `.planning/phases/05-wizard-ui/05-01-SUMMARY.md`
</output>
