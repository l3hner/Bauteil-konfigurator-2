---
phase: 05-wizard-ui
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - views/index.ejs
  - src/routes/submit.js
autonomous: true

must_haves:
  truths:
    - "Every catalog-based radio card shows a product image thumbnail above the text content"
    - "Haustypen radio cards use filePath + '1.png' as the thumbnail image"
    - "Radio cards without a filePath (e.g., lueftung 'keine') show text-only without broken image"
    - "Server-side validation rejects submissions with missing required fields and returns German error messages"
    - "Client-side wizard validation and server-side validation use the same set of required fields"
  artifacts:
    - path: "views/index.ejs"
      provides: "Product image thumbnails in all catalog radio cards (haustypen, innenwalls, decken, windows, daecher, tiles, treppen, heizung sections)"
      contains: "radio-card--with-image"
    - path: "src/routes/submit.js"
      provides: "Server-side required-field validation with German error messages before catalog validation"
      contains: "Pflichtfeld"
  key_links:
    - from: "views/index.ejs"
      to: "data/catalog.json"
      via: "EJS template uses catalog.*.filePath for product image src"
      pattern: "filePath"
    - from: "src/routes/submit.js"
      to: "views/index.ejs"
      via: "Server validates same fields that wizard requires on client side"
      pattern: "bauherr_anrede|bauherr_vorname|kfw_standard|haustyp|wall"
---

<objective>
Add product images to all catalog-based radio cards in the EJS template and add server-side required-field validation to the submit route.

Purpose: Product images are a core success criterion (WIZ-04) -- Fachberater and customers must see what they're selecting, not just text. Server-side validation is the security boundary (WIZ-03) -- client-side wizard validation is UX convenience, server validation prevents incomplete submissions.

Output: Updated index.ejs with product image cards, updated submit.js with required-field validation.
</objective>

<execution_context>
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-wizard-ui/05-RESEARCH.md
@.planning/phases/05-wizard-ui/05-01-SUMMARY.md

Key existing files:
@views/index.ejs — Will already have data-wizard-step attributes and wizard script tags from 05-01
@src/routes/submit.js — Current POST handler with catalog validation but no required-field validation
@data/catalog.json — 9 categories, all entries have filePath field; haustypen filePath is a directory (e.g., "assets/variants/haustypen/bungalow/")
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add product images to all catalog radio cards in index.ejs</name>
  <files>views/index.ejs</files>
  <action>
  Modify every catalog-based radio card section in index.ejs to include a product image thumbnail. The pattern is the same for all sections, with one exception for haustypen (directory-based filePath).

  **For each catalog section (innerwalls, decken, windows, daecher, tiles, treppen, heizung):**

  Transform the existing radio card pattern:
  ```html
  <label class="radio-card">
      <input type="radio" name="FIELD" value="<%= item.id %>">
      <div class="radio-content">
          <h4><%= item.name %></h4>
          <p><%= item.description %></p>
      </div>
      <span class="checkmark">...</span>
  </label>
  ```

  Into the image-enhanced pattern:
  ```html
  <label class="radio-card<%= item.filePath ? ' radio-card--with-image' : '' %>">
      <input type="radio" name="FIELD" value="<%= item.id %>" onchange="updateProgress();">
      <% if (item.filePath) { %>
      <div class="radio-card-image">
          <img src="/<%= item.filePath %>" alt="<%= item.name %>" loading="lazy">
      </div>
      <% } %>
      <div class="radio-content">
          <h4><%= item.name %></h4>
          <p><%= item.description %></p>
      </div>
      <span class="checkmark">...</span>
  </label>
  ```

  **Sections to update (with their loop variable and field name):**

  1. **Section 2 (Haustyp)** -- `catalog.haustypen` / `haustyp` / variable: `haustyp`
     - SPECIAL: haustypen `filePath` is a directory like `"assets/variants/haustypen/bungalow/"`. Use `filePath + '1.png'` as the image src:
       ```html
       <img src="/<%= haustyp.filePath %>1.png" alt="<%= haustyp.name %>" loading="lazy">
       ```
     - Keep the existing `<small><%= haustyp.details %></small>` line inside radio-content.

  2. **Section 5 (Innenwand)** -- `catalog.innenwalls` / `innerwall` / variable: `innerwall`

  3. **Section 6 (Decke)** -- `catalog.decken` / `decke` / variable: `decke`

  4. **Section 7 (Fenster)** -- `catalog.windows` / `window` / variable: `window` (NOTE: JS uses `window` as global -- but in EJS template context this is fine since it's a server-side loop variable)

  5. **Section 8 (Dachform)** -- `catalog.daecher` / `dach` / variable: `dach`

  6. **Section 9 (Dacheindeckung)** -- `catalog.tiles` / `tiles` / variable: `tile`

  7. **Section 10 (Treppensystem)** -- `catalog.treppen` / `treppe` / variable: `treppe`
     - Some entries may have `filePath: null` (e.g., "keine Treppe"). The conditional `<% if (item.filePath) { %>` handles this gracefully -- no image div rendered, no `radio-card--with-image` class.

  8. **Section 11 (Heizung)** -- `catalog.heizung` / `heizung` / variable: `heiz`

  **Sections NOT updated (dynamically rendered in JS):**
  - Section 4 (Aussenwand) -- wall options rendered by `updateWallOptions()` in script.js. Product images would need to be added to the JS template string. For consistency, also update `updateWallOptions()` and `updateLueftungOptions()` in script.js to include images IF wall/lueftung catalog data has filePath. However, these functions use hardcoded arrays, not catalog data. Since the wall/lueftung data in script.js doesn't include filePath, skip image cards for these two. The catalog.json does have filePath for walls and lueftung, but the JS-side data arrays (wallOptions, lueftungOptions in script.js) only have id, name, description. Adding images to these would require passing catalog data to the client or restructuring the JS data. **Leave wall and lueftung radio cards as text-only for now** -- this is a conscious scope decision. (Future enhancement: embed full catalog data in EJS and use it in JS.)

  - Section 12 (Lueftung) -- same as above, dynamically rendered by `updateLueftungOptions()`.

  **Preserve all existing attributes** on the radio inputs: `name`, `value`, `onchange`, `required`. Do not break any existing functionality.
  </action>
  <verify>
  - Start server, open `/`, navigate through wizard steps
  - Section 2 (Haustyp): Each haustyp card shows a house image (or placeholder) above the text
  - Section 5-11: Each catalog-based card shows a product image above the text
  - Cards without filePath (e.g., "keine Treppe") show text-only, no broken image icon
  - Images use `loading="lazy"` attribute
  - Radio selection still works correctly (clicking the image or text selects the radio)
  </verify>
  <done>All catalog-based radio cards (8 sections) display product images. Haustypen use directory + 1.png convention. Cards without filePath are gracefully text-only.</done>
</task>

<task type="auto">
  <name>Task 2: Add server-side required-field validation to submit route</name>
  <files>src/routes/submit.js</files>
  <action>
  Add server-side validation of ALL required fields at the top of the POST handler, BEFORE the existing `catalogService.validateSelection()` call. This is the security boundary -- the client-side wizard validation is UX, not security.

  **Add after `const formData = req.body;` (line 9) and before `const rooms = submissionService.parseRoomData(formData);` (line 12):**

  ```javascript
  // Server-side required field validation
  const requiredFields = {
    bauherr_anrede: 'Anrede ist ein Pflichtfeld.',
    bauherr_vorname: 'Vorname ist ein Pflichtfeld.',
    bauherr_nachname: 'Nachname ist ein Pflichtfeld.',
    kfw_standard: 'Bitte wahlen Sie einen Energiestandard.',
    haustyp: 'Bitte wahlen Sie einen Haustyp.',
    wall: 'Bitte wahlen Sie ein Aussenwandsystem.',
    innerwall: 'Bitte wahlen Sie ein Innenwandsystem.',
    decke: 'Bitte wahlen Sie ein Deckensystem.',
    window: 'Bitte wahlen Sie ein Fenstersystem.',
    tiles: 'Bitte wahlen Sie eine Dacheindeckung.',
    dach: 'Bitte wahlen Sie eine Dachform.',
    treppe: 'Bitte wahlen Sie eine Treppenoption.',
    heizung: 'Bitte wahlen Sie ein Heizungssystem.',
    lueftung: 'Bitte wahlen Sie ein Luftungssystem.',
    personenanzahl: 'Bitte geben Sie die Personenanzahl an.',
    grundstueck: 'Bitte geben Sie den Grundstucksstatus an.'
  };

  const missingFields = [];
  for (const [field, message] of Object.entries(requiredFields)) {
    if (!formData[field] || !formData[field].toString().trim()) {
      missingFields.push({ field, message });
    }
  }

  if (missingFields.length > 0) {
    return res.status(400).json({
      error: 'Pflichtfelder fehlen',
      details: missingFields
    });
  }
  ```

  **Also update initFormValidation() in script.js** (if not already done in 05-01) to handle the 400 response from server-side validation. Currently, the form submits as a traditional POST and the browser handles the redirect. If the server returns a 400 JSON, the browser will show raw JSON. To handle this:

  Actually, since the form uses traditional POST (not AJAX), the 400 JSON response would display as raw JSON in the browser. This is not ideal. Instead of returning JSON on validation failure, redirect back to the form with an error:

  **Revised approach:** Instead of returning JSON, use `res.redirect('/?error=missing_fields')` or render the form again with errors. But since the wizard handles client-side validation, the server-side validation is a safety net for direct POST requests (e.g., from curl or modified forms). Returning 400 JSON is acceptable for this security boundary. The wizard's client-side validation prevents normal users from ever hitting this code path.

  Keep the 400 JSON response. The client-side wizard validation is the primary UX guard.
  </action>
  <verify>
  - Test with curl: `curl -X POST http://localhost:3000/submit -H "Content-Type: application/x-www-form-urlencoded" -d ""` should return 400 with JSON listing all missing fields
  - Test with curl sending partial data: `curl -X POST http://localhost:3000/submit -d "bauherr_vorname=Test&bauherr_nachname=User"` should return 400 listing remaining missing fields
  - Normal form submission through the wizard (all fields filled) should still work and redirect to result page
  </verify>
  <done>Server-side validation rejects incomplete submissions with 400 and German error messages. All 16 required fields are validated. Normal wizard submissions pass through to catalog validation and PDF generation.</done>
</task>

</tasks>

<verification>
1. All 8 catalog-based sections show product images in radio cards
2. Haustypen images load correctly (directory + 1.png convention)
3. Cards without images (keine Treppe, keine Lueftung) are text-only without broken images
4. Server rejects empty/partial POST requests with 400 and German error messages
5. Full wizard submission (all fields) succeeds with redirect to result page
6. Generated PDF is identical to before (no template changes affect submission data)
</verification>

<success_criteria>
- Product images visible in radio cards for all catalog-based component selections (haustypen, innenwalls, decken, windows, daecher, tiles, treppen, heizung)
- Server-side validation catches all 16 required fields and returns German error messages
- No visual regression in existing radio card selection behavior
- No new npm dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/05-wizard-ui/05-02-SUMMARY.md`
</output>
