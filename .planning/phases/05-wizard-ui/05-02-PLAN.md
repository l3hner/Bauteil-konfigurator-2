---
phase: 05-wizard-ui
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - views/index.ejs
  - src/routes/submit.js
  - public/js/script.js
autonomous: true

must_haves:
  truths:
    - "Every catalog-based radio card shows a product image thumbnail above the text content"
    - "Haustypen radio cards use filePath + '1.png' as the thumbnail image"
    - "Radio cards without a filePath (e.g., lueftung 'keine') show text-only without broken image"
    - "Server-side validation rejects submissions with missing required fields and returns German error messages"
    - "Client-side wizard validation and server-side validation use the same set of required fields"
  artifacts:
    - path: "views/index.ejs"
      provides: "Product image thumbnails in all catalog radio cards (haustypen, innenwalls, decken, windows, daecher, tiles, treppen, heizung sections)"
      contains: "radio-card--with-image"
    - path: "public/js/script.js"
      provides: "Product image thumbnails in dynamically-rendered wall and lueftung radio cards via filePath in wallOptions/lueftungOptions data arrays"
      contains: "radio-card--with-image"
    - path: "src/routes/submit.js"
      provides: "Server-side required-field validation with German error messages before catalog validation"
      contains: "Pflichtfeld"
  key_links:
    - from: "views/index.ejs"
      to: "data/catalog.json"
      via: "EJS template uses catalog.*.filePath for product image src"
      pattern: "filePath"
    - from: "src/routes/submit.js"
      to: "views/index.ejs"
      via: "Server validates same fields that wizard requires on client side"
      pattern: "bauherr_anrede|bauherr_vorname|kfw_standard|haustyp|wall"
---

<objective>
Add product images to all catalog-based radio cards in the EJS template and add server-side required-field validation to the submit route.

Purpose: Product images are a core success criterion (WIZ-04) -- Fachberater and customers must see what they're selecting, not just text. Server-side validation is the security boundary (WIZ-03) -- client-side wizard validation is UX convenience, server validation prevents incomplete submissions.

Output: Updated index.ejs with product image cards, updated submit.js with required-field validation.
</objective>

<execution_context>
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-wizard-ui/05-RESEARCH.md
@.planning/phases/05-wizard-ui/05-01-SUMMARY.md

Key existing files:
@views/index.ejs — Will already have data-wizard-step attributes and wizard script tags from 05-01
@src/routes/submit.js — Current POST handler with catalog validation but no required-field validation
@data/catalog.json — 9 categories, all entries have filePath field; haustypen filePath is a directory (e.g., "assets/variants/haustypen/bungalow/")
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add product images to all catalog radio cards in index.ejs and script.js</name>
  <files>views/index.ejs, public/js/script.js</files>
  <action>
  Modify every catalog-based radio card section in index.ejs to include a product image thumbnail. The pattern is the same for all sections, with one exception for haustypen (directory-based filePath).

  **For each catalog section (innerwalls, decken, windows, daecher, tiles, treppen, heizung):**

  Transform the existing radio card pattern:
  ```html
  <label class="radio-card">
      <input type="radio" name="FIELD" value="<%= item.id %>">
      <div class="radio-content">
          <h4><%= item.name %></h4>
          <p><%= item.description %></p>
      </div>
      <span class="checkmark">...</span>
  </label>
  ```

  Into the image-enhanced pattern:
  ```html
  <label class="radio-card<%= item.filePath ? ' radio-card--with-image' : '' %>">
      <input type="radio" name="FIELD" value="<%= item.id %>" onchange="updateProgress();">
      <% if (item.filePath) { %>
      <div class="radio-card-image">
          <img src="/<%= item.filePath %>" alt="<%= item.name %>" loading="lazy">
      </div>
      <% } %>
      <div class="radio-content">
          <h4><%= item.name %></h4>
          <p><%= item.description %></p>
      </div>
      <span class="checkmark">...</span>
  </label>
  ```

  **Sections to update (with their loop variable and field name):**

  1. **Section 2 (Haustyp)** -- `catalog.haustypen` / `haustyp` / variable: `haustyp`
     - SPECIAL: haustypen `filePath` is a directory like `"assets/variants/haustypen/bungalow/"`. Use `filePath + '1.png'` as the image src:
       ```html
       <img src="/<%= haustyp.filePath %>1.png" alt="<%= haustyp.name %>" loading="lazy">
       ```
     - Keep the existing `<small><%= haustyp.details %></small>` line inside radio-content.

  2. **Section 5 (Innenwand)** -- `catalog.innenwalls` / `innerwall` / variable: `innerwall`

  3. **Section 6 (Decke)** -- `catalog.decken` / `decke` / variable: `decke`

  4. **Section 7 (Fenster)** -- `catalog.windows` / `window` / variable: `window` (NOTE: JS uses `window` as global -- but in EJS template context this is fine since it's a server-side loop variable)

  5. **Section 8 (Dachform)** -- `catalog.daecher` / `dach` / variable: `dach`

  6. **Section 9 (Dacheindeckung)** -- `catalog.tiles` / `tiles` / variable: `tile`

  7. **Section 10 (Treppensystem)** -- `catalog.treppen` / `treppe` / variable: `treppe`
     - Some entries may have `filePath: null` (e.g., "keine Treppe"). The conditional `<% if (item.filePath) { %>` handles this gracefully -- no image div rendered, no `radio-card--with-image` class.

  8. **Section 11 (Heizung)** -- `catalog.heizung` / `heizung` / variable: `heiz`

  **Sections dynamically rendered in JS (require script.js changes):**

  9. **Section 4 (Aussenwand)** -- rendered by `updateWallOptions()` in script.js.
     - Add `filePath` to each entry in the `wallOptions` data arrays in script.js, matching catalog.json values:
       ```javascript
       KFW55: [
           { id: 'climativ', name: 'CLIMA-tiv', description: 'Mit Holzwerkstoffplatte - 270 mm Wandstarke', filePath: 'assets/variants/walls/climativ-esb.png' },
           { id: 'climativ-gf', name: 'CLIMA-tiv (GF)', description: 'Mit Gipsfaserplatte - 270 mm Wandstarke', filePath: 'assets/variants/walls/climativ-fermacell.png' }
       ],
       KFW40: [
           { id: 'climativ-plus', name: 'CLIMA-tiv plus', description: 'Mit Holzwerkstoffplatte - 350 mm Wandstarke', filePath: 'assets/variants/walls/climativ-plus-esb.png' },
           { id: 'climativ-plus-gf', name: 'CLIMA-tiv plus (GF)', description: 'Mit Gipsfaserplatte - 350 mm Wandstarke', filePath: 'assets/variants/walls/climativ-plus-fermacell.png' }
       ]
       ```
     - Update the template string in `updateWallOptions()` to render an image thumbnail when `wall.filePath` is present:
       ```javascript
       html += `
           <label class="radio-card${wall.filePath ? ' radio-card--with-image' : ''}">
               <input type="radio" name="wall" value="${wall.id}" onchange="handleRadioSelect(this); updateProgress(); if(typeof WizardState !== 'undefined') WizardState.save();">
               ${wall.filePath ? `<div class="radio-card-image"><img src="/${wall.filePath}" alt="${wall.name}" loading="lazy"></div>` : ''}
               <div class="radio-content">
                   <h4>${wall.name}</h4>
                   <p>${wall.description}</p>
               </div>
               <span class="checkmark">
                   <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
               </span>
           </label>
       `;
       ```

  10. **Section 12 (Lueftung)** -- rendered by `updateLueftungOptions()` in script.js.
      - Add `filePath` to each entry in the `lueftungOptions` data arrays, matching catalog.json values. Note: "keine" has no image (filePath: null):
        ```javascript
        KFW55: [
            { id: 'keine', name: 'Keine Luftungsanlage', description: 'Naturliche Luftung uber Fenster (bei KfW 55 ausreichend)', filePath: null }
        ],
        KFW40: [
            { id: 'dezentral', name: 'Dezentrale Luftung', description: 'Einzelraumluftung mit Warmeruckgewinnung', filePath: 'assets/variants/lueftung/dezentral.png' },
            { id: 'zentral', name: 'Zentrale Luftungsanlage', description: 'Komfort-Luftung mit zentraler Steuerung', filePath: 'assets/variants/lueftung/zentral.png' }
        ]
        ```
      - Update the template string in `updateLueftungOptions()` to render an image thumbnail when `lueftung.filePath` is present (same pattern as walls above). The "keine" entry with `filePath: null` will render as text-only.

  **Preserve all existing attributes** on the radio inputs: `name`, `value`, `onchange`, `required`. Do not break any existing functionality.
  </action>
  <verify>
  - Start server, open `/`, navigate through wizard steps
  - Section 2 (Haustyp): Each haustyp card shows a house image (or placeholder) above the text
  - Section 4 (Wand): After selecting KfW standard, wall cards show product images above the text
  - Section 5-11: Each catalog-based card shows a product image above the text
  - Section 12 (Lueftung): After selecting KfW40, dezentral/zentral cards show images; "keine" is text-only
  - Cards without filePath (e.g., "keine Treppe", "keine Lueftung") show text-only, no broken image icon
  - Images use `loading="lazy"` attribute
  - Radio selection still works correctly (clicking the image or text selects the radio)
  </verify>
  <done>All catalog-based radio cards (10 sections including dynamically-rendered wall and lueftung) display product images. Haustypen use directory + 1.png convention. Cards without filePath are gracefully text-only.</done>
</task>

<task type="auto">
  <name>Task 2: Add server-side required-field validation to submit route</name>
  <files>src/routes/submit.js</files>
  <action>
  Add server-side validation of ALL required fields at the top of the POST handler, BEFORE the existing `catalogService.validateSelection()` call. This is the security boundary -- the client-side wizard validation is UX, not security.

  **Add after `const formData = req.body;` (line 9) and before `const rooms = submissionService.parseRoomData(formData);` (line 12):**

  ```javascript
  // Server-side required field validation
  const requiredFields = {
    bauherr_anrede: 'Anrede ist ein Pflichtfeld.',
    bauherr_vorname: 'Vorname ist ein Pflichtfeld.',
    bauherr_nachname: 'Nachname ist ein Pflichtfeld.',
    kfw_standard: 'Bitte wahlen Sie einen Energiestandard.',
    haustyp: 'Bitte wahlen Sie einen Haustyp.',
    wall: 'Bitte wahlen Sie ein Aussenwandsystem.',
    innerwall: 'Bitte wahlen Sie ein Innenwandsystem.',
    decke: 'Bitte wahlen Sie ein Deckensystem.',
    window: 'Bitte wahlen Sie ein Fenstersystem.',
    tiles: 'Bitte wahlen Sie eine Dacheindeckung.',
    dach: 'Bitte wahlen Sie eine Dachform.',
    treppe: 'Bitte wahlen Sie eine Treppenoption.',
    heizung: 'Bitte wahlen Sie ein Heizungssystem.',
    lueftung: 'Bitte wahlen Sie ein Luftungssystem.',
    personenanzahl: 'Bitte geben Sie die Personenanzahl an.',
    grundstueck: 'Bitte geben Sie den Grundstucksstatus an.'
  };

  const missingFields = [];
  for (const [field, message] of Object.entries(requiredFields)) {
    if (!formData[field] || !formData[field].toString().trim()) {
      missingFields.push({ field, message });
    }
  }

  if (missingFields.length > 0) {
    return res.status(400).json({
      error: 'Pflichtfelder fehlen',
      details: missingFields
    });
  }
  ```

  **Also update initFormValidation() in script.js** (if not already done in 05-01) to handle the 400 response from server-side validation. Currently, the form submits as a traditional POST and the browser handles the redirect. If the server returns a 400 JSON, the browser will show raw JSON. To handle this:

  Actually, since the form uses traditional POST (not AJAX), the 400 JSON response would display as raw JSON in the browser. This is not ideal. Instead of returning JSON on validation failure, redirect back to the form with an error:

  **Revised approach:** Instead of returning JSON, use `res.redirect('/?error=missing_fields')` or render the form again with errors. But since the wizard handles client-side validation, the server-side validation is a safety net for direct POST requests (e.g., from curl or modified forms). Returning 400 JSON is acceptable for this security boundary. The wizard's client-side validation prevents normal users from ever hitting this code path.

  Keep the 400 JSON response. The client-side wizard validation is the primary UX guard.
  </action>
  <verify>
  - Test with curl: `curl -X POST http://localhost:3000/submit -H "Content-Type: application/x-www-form-urlencoded" -d ""` should return 400 with JSON listing all missing fields
  - Test with curl sending partial data: `curl -X POST http://localhost:3000/submit -d "bauherr_vorname=Test&bauherr_nachname=User"` should return 400 listing remaining missing fields
  - Normal form submission through the wizard (all fields filled) should still work and redirect to result page
  </verify>
  <done>Server-side validation rejects incomplete submissions with 400 and German error messages. All 16 required fields are validated. Normal wizard submissions pass through to catalog validation and PDF generation.</done>
</task>

</tasks>

<verification>
1. All 10 catalog-based sections show product images in radio cards (8 EJS-rendered + 2 JS-rendered: wall, lueftung)
2. Haustypen images load correctly (directory + 1.png convention)
3. Wall and lueftung cards show images after KfW standard is selected
4. Cards without images (keine Treppe, keine Lueftung) are text-only without broken images
5. Server rejects empty/partial POST requests with 400 and German error messages
6. Full wizard submission (all fields) succeeds with redirect to result page
7. Generated PDF is identical to before (no template changes affect submission data)
</verification>

<success_criteria>
- Product images visible in radio cards for ALL component selections including dynamically-rendered wall and lueftung (haustypen, walls, innenwalls, decken, windows, daecher, tiles, treppen, heizung, lueftung)
- Server-side validation catches all 16 required fields and returns German error messages
- No visual regression in existing radio card selection behavior
- No new npm dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/05-wizard-ui/05-02-SUMMARY.md`
</output>
