---
phase: 01-catalog-expansion
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/routes/index.js
  - src/routes/submit.js
  - views/index.ejs
  - public/js/script.js
  - src/services/pdfService.js
  - views/result.ejs
autonomous: true

must_haves:
  truths:
    - "The configuration form shows a Dachform section with 4 radio cards and a Treppen section with 5 radio cards"
    - "Submitting the form with dach and treppe selections saves both fields to the submission JSON"
    - "The generated PDF includes a Dachform component page when a Dachform is selected"
    - "The generated PDF includes a Treppensystem component page when a Treppe (not 'keine') is selected"
    - "The PDF executive summary, Leistungsübersicht, and overview pages list Dachform and Treppe entries"
    - "Old submissions without dach/treppe fields generate PDFs without errors (pages simply skipped)"
    - "Progress bar reflects the correct total number of form steps after adding 2 new sections"
  artifacts:
    - path: "src/routes/index.js"
      provides: "daecher and treppen passed to EJS template"
      contains: "getDaecher"
    - path: "src/routes/submit.js"
      provides: "dach and treppe fields in submission object"
      contains: "formData.dach"
    - path: "views/index.ejs"
      provides: "Form sections for Dachform and Treppen selection"
      contains: "name=\"dach\""
    - path: "public/js/script.js"
      provides: "Updated progress tracking with new section count"
    - path: "src/services/pdfService.js"
      provides: "Dachform and Treppensystem in components array, executive summary, Leistungsübersicht, and overview"
      contains: "Dachform"
    - path: "views/result.ejs"
      provides: "Dach and Treppe shown in result summary"
  key_links:
    - from: "src/routes/index.js"
      to: "views/index.ejs"
      via: "catalog.daecher and catalog.treppen passed to res.render"
      pattern: "catalog\\.daecher"
    - from: "views/index.ejs"
      to: "src/routes/submit.js"
      via: "form POST with name=dach and name=treppe"
      pattern: "name=\"dach\""
    - from: "src/routes/submit.js"
      to: "src/services/pdfService.js"
      via: "submission.dach and submission.treppe in saved JSON"
      pattern: "submission\\.dach"
    - from: "src/services/pdfService.js"
      to: "src/services/catalogService.js"
      via: "getVariantById('daecher', submission.dach) lookups"
      pattern: "getVariantById\\('daecher'"
---

<objective>
Integrate the new Daecher and Treppen catalog categories into the full request flow: form UI, route handlers, PDF generation (all 4 component-listing methods), and result page.

Purpose: Complete the end-to-end user flow so a Fachberater can select Dachform and Treppen in the form, submit, and receive a PDF with those components. This is the core deliverable of Phase 1.
Output: Working form-to-PDF flow for both new categories.
</objective>

<execution_context>
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-catalog-expansion/01-RESEARCH.md
@.planning/phases/01-catalog-expansion/01-01-SUMMARY.md

@src/routes/index.js
@src/routes/submit.js
@views/index.ejs
@public/js/script.js
@src/services/pdfService.js
@views/result.ejs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add routes, form sections, and progress tracking for Dachform and Treppen</name>
  <files>src/routes/index.js, src/routes/submit.js, views/index.ejs, public/js/script.js</files>
  <action>
**src/routes/index.js:**
1. Add after existing catalog loads:
   ```javascript
   const daecher = catalogService.getDaecher();
   const treppen = catalogService.getTreppen();
   ```
2. Add to the console.log block:
   ```javascript
   console.log('  - daecher:', daecher.length);
   console.log('  - treppen:', treppen.length);
   ```
3. Add `daecher` and `treppen` to the `catalog` object passed to `res.render`.

**src/routes/submit.js:**
Add `dach` and `treppe` fields to the submission object in the "Building components" section:
```javascript
dach: formData.dach || null,
treppe: formData.treppe || null,
```
Use `|| null` (not just `formData.dach`) so that empty/missing form values become explicit null rather than undefined or empty string. This ensures clean JSON serialization.

**views/index.ejs:**
Add two new form sections. Placement per research recommendation: Dachform BEFORE Dacheindeckung (tiles), Treppen AFTER Dacheindeckung.

Find the current section for "Dacheindeckung" (tiles). Insert a new section BEFORE it for Dachform. Then insert a new section AFTER the Dacheindeckung section for Treppen.

**Dachform section** (follows exact same HTML pattern as other radio-card sections like decken):
```html
<section class="form-section" id="section-N">
    <h3 class="section-title">N. Dachform</h3>
    <div class="radio-group">
        <% catalog.daecher.forEach(dach => { %>
        <label class="radio-card">
            <input type="radio" name="dach" value="<%= dach.id %>" onchange="updateProgress();">
            <div class="radio-content">
                <h4><%= dach.name %></h4>
                <p><%= dach.description %></p>
            </div>
            <span class="checkmark">
                <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
            </span>
        </label>
        <% }); %>
    </div>
</section>
```

**Treppen section** (same pattern, placed AFTER Dacheindeckung):
```html
<section class="form-section" id="section-N">
    <h3 class="section-title">N. Treppensystem</h3>
    <div class="radio-group">
        <% catalog.treppen.forEach(treppe => { %>
        <label class="radio-card">
            <input type="radio" name="treppe" value="<%= treppe.id %>" onchange="updateProgress();">
            <div class="radio-content">
                <h4><%= treppe.name %></h4>
                <p><%= treppe.description %></p>
            </div>
            <span class="checkmark">
                <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
            </span>
        </label>
        <% }); %>
    </div>
</section>
```

IMPORTANT: Renumber ALL subsequent sections (the ones after the insertion points) to maintain continuous numbering. Also update the progress step indicators in the HTML if they reference section numbers.

**public/js/script.js:**
1. Find the `sections` object that maps step numbers to section IDs. Add entries for the two new sections matching whatever section IDs/numbers you assigned in the EJS.
2. Update `totalSteps` to reflect the new total count (previous count + 2).
3. If there are progress step indicators that reference section labels, add labels for "Dachform" and "Treppensystem".

Read the current script.js carefully to understand the exact progress tracking mechanism before making changes. The section numbering in script.js MUST match the section numbering in index.ejs exactly.
  </action>
  <verify>
1. Start the server: `npm start` (or PORT=3001 npm start if 3000 is in use)
2. Open http://localhost:3000 in browser
3. Verify: Dachform section appears with 4 radio options (Satteldach, Walmdach, Pultdach, Flachdach)
4. Verify: Treppensystem section appears with 5 radio options (Keine Treppe, Holzwangentreppe, Betontreppe, Stahl-Holz-Treppe, Außentreppe)
5. Verify: Progress bar updates when selecting options in new sections
6. Verify: Section numbering is continuous (no gaps, no duplicates)
7. Verify: Form can be submitted with new selections (fills in all required fields, clicks submit)
  </verify>
  <done>Configuration form shows Dachform (4 options) and Treppensystem (5 options) sections with working radio cards, progress bar tracks both new sections, and form submission includes dach/treppe fields in the saved JSON.</done>
</task>

<task type="auto">
  <name>Task 2: Extend pdfService with Dachform and Treppensystem in all component-listing methods</name>
  <files>src/services/pdfService.js, views/result.ejs</files>
  <action>
**pdfService.js — 4 locations must be updated:**

Read the full pdfService.js first. Identify each location by searching for `getVariantById` calls that build component lists. Per research, there are 4 methods that must include the new categories:

**Location 1: generatePDF() components array (~line 128)**
Add two entries to the `components` array:
```javascript
{ title: 'Dachform', data: catalogService.getVariantById('daecher', submission.dach), chapter: '5.7' },
```
Place AFTER the 'Dacheindeckung' entry (chapter 5.6) and BEFORE 'Heizungssystem' (chapter 6.1).

For Treppen, use the same conditional pattern as Lüftung (skip if 'keine' or null):
```javascript
// Treppe hinzufügen wenn gewählt (nicht 'keine')
if (submission.treppe && submission.treppe !== 'keine') {
  const treppe = catalogService.getVariantById('treppen', submission.treppe);
  if (treppe && treppe.id !== 'keine') {
    components.push({ title: 'Treppensystem', data: treppe, chapter: '5.8' });
  }
}
```

**Location 2: drawExecutiveSummary() (~line 473)**
This method builds a summary table. Find where component lookups happen (wall, innerwall, decke, etc.) and add:
```javascript
const dach = catalogService.getVariantById('daecher', submission.dach);
const treppe = catalogService.getVariantById('treppen', submission.treppe);
```

Then add rows to the components table:
```javascript
['Dachform', dach?.name, ''],
```
And conditionally for Treppen:
```javascript
if (treppe && treppe.id !== 'keine') {
  // add row: ['Treppe', treppe?.name, '']
}
```

Use optional chaining (`?.`) on all property accesses for backward compatibility with old submissions where dach/treppe are undefined.

**Location 3: drawLeistungsuebersicht() (~line 631)**
This method builds a highlights list. Find where wall, innerwall, decke, tiles are looked up and add:
```javascript
const dach = catalogService.getVariantById('daecher', submission.dach);
const treppe = catalogService.getVariantById('treppen', submission.treppe);
```

Add entries to whatever list structure this method uses for component highlights, following the existing pattern. Guard with `if (dach)` and `if (treppe && treppe.id !== 'keine')`.

**Location 4: drawOverviewContent() (~line 702)**
Find where wall, innerwall, decke, windowData, tiles, heizung, lueftung are looked up and add:
```javascript
const dach = catalogService.getVariantById('daecher', submission.dach);
const treppe = catalogService.getVariantById('treppen', submission.treppe);
```

Add to the componentsList array:
```javascript
{ label: 'Dachform', data: dach },
```
And conditionally:
```javascript
if (treppe && treppe.id !== 'keine') {
  componentsList.push({ label: 'Treppe', data: treppe });
}
```

**CRITICAL DEFENSIVE PATTERN:** In ALL 4 locations, use `?.` (optional chaining) when accessing properties of looked-up variants (e.g., `dach?.name`, `treppe?.name`). This ensures old submissions without dach/treppe fields produce `undefined` lookups that are safely skipped rather than causing crashes.

**views/result.ejs:**
If the result page displays a summary of selected components, add entries for Dachform and Treppe. Follow the existing display pattern. Guard with `<% if (submission.dach) { %>` and `<% if (submission.treppe && submission.treppe !== 'keine') { %>`.
  </action>
  <verify>
1. Generate a PDF by submitting a configuration with Dachform and Treppe selected
2. Open the PDF and verify:
   - A "Dachform" component page exists with product image placeholder, name, description, advantages
   - A "Treppensystem" component page exists (if treppe !== 'keine')
   - Executive Summary table includes Dachform and Treppe rows
   - Leistungsübersicht mentions Dachform and Treppe
   - Overview content lists Dachform and Treppe
3. Test backward compatibility: Load an existing old submission's result page (e.g., /result/b6df1b5e-44c0-4d38-ac2c-cc9ce58e0e85) — should load without 500 error
4. Test with 'keine' treppe: Submit with treppe='keine' — PDF should NOT have a Treppensystem page
  </verify>
  <done>PDF generation includes Dachform and Treppensystem component pages, executive summary rows, Leistungsübersicht entries, and overview entries for new categories. Old submissions without dach/treppe generate PDFs without errors. Result page shows new component selections.</done>
</task>

</tasks>

<verification>
1. Full end-to-end test: Fill form with all fields including Dachform=Satteldach and Treppe=Holzwangentreppe, submit, verify PDF has both component pages
2. Full end-to-end test with keine Treppe: Submit with treppe=keine, verify PDF skips Treppensystem page
3. Backward compatibility: Navigate to /result/{existing-old-submission-id}, verify no 500 error
4. Backward compatibility: Regenerate PDF for old submission (if possible via existing route), verify no crash
5. Progress bar: Count total form sections, verify progress bar shows correct total
6. Section numbering: Verify all sections are numbered continuously with no gaps
</verification>

<success_criteria>
- Form shows Dachform (4 options) and Treppensystem (5 options) with correct German labels
- Form submission saves dach and treppe to submission JSON
- PDF has dedicated Dachform component page with image, name, advantages
- PDF has dedicated Treppensystem component page (skipped for 'keine')
- PDF executive summary, Leistungsübersicht, and overview include new categories
- Old submissions (without dach/treppe) load and generate PDF without errors
- Progress bar reflects updated section count
</success_criteria>

<output>
After completion, create `.planning/phases/01-catalog-expansion/01-02-SUMMARY.md`
</output>
