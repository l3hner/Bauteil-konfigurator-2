---
phase: 01-catalog-expansion
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/migrate-submissions.js
  - src/services/submissionService.js
autonomous: true

must_haves:
  truths:
    - "Running the migration script adds dach:null, treppe:null, and schemaVersion:2 to all existing submissions"
    - "Already-migrated submissions (schemaVersion >= 2) are skipped without modification"
    - "The migration script logs how many submissions were migrated and how many were skipped"
    - "submissionService.saveSubmission() sets schemaVersion:2 on all new submissions"
  artifacts:
    - path: "scripts/migrate-submissions.js"
      provides: "Idempotent migration script for existing submission JSON files"
      contains: "schemaVersion"
    - path: "src/services/submissionService.js"
      provides: "schemaVersion field set on new submissions"
      contains: "schemaVersion"
  key_links:
    - from: "scripts/migrate-submissions.js"
      to: "data/submissions/*.json"
      via: "fs.readdir + JSON.parse + fs.writeFile for each submission"
      pattern: "schemaVersion"
    - from: "src/services/submissionService.js"
      to: "data/submissions/*.json"
      via: "saveSubmission sets schemaVersion on new submissions"
      pattern: "schemaVersion.*2"
---

<objective>
Create an idempotent migration script that adds missing dach/treppe/decke fields and a schemaVersion to existing submissions, and update submissionService to stamp new submissions with schemaVersion:2.

Purpose: Ensure backward compatibility — old submissions without the new fields do not cause runtime errors, and future migrations have a version field to key on.
Output: Migration script, updated submissionService, all existing submissions migrated.
</objective>

<execution_context>
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-catalog-expansion/01-RESEARCH.md

@src/services/submissionService.js
@data/submissions/b6df1b5e-44c0-4d38-ac2c-cc9ce58e0e85.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create idempotent submission migration script</name>
  <files>scripts/migrate-submissions.js</files>
  <action>
Create a new file `scripts/migrate-submissions.js` that:

1. Reads all .json files from `data/submissions/` directory
2. For each file:
   a. Parse the JSON
   b. Check if `schemaVersion >= 2` — if so, skip (log as "skipped")
   c. Otherwise, add missing fields with null defaults:
      - `dach: null` (if not present)
      - `treppe: null` (if not present)
      - `decke: null` (if not present — some old submissions also lack this)
      - `schemaVersion: 2`
   d. Write the updated JSON back (pretty-printed with 2-space indent)
   e. Log which file was migrated

3. Print summary at the end: "Migration complete. Migrated: X, Skipped: Y, Errors: Z"

4. Handle errors per-file (log error, continue to next file, count as error)

Use `require('fs').promises` for async file operations. Use `path.join(__dirname, '..', 'data', 'submissions')` for the directory path.

The script must be idempotent: running it twice produces the same result (second run skips all already-migrated files).

Add a check at the start: if the submissions directory doesn't exist or is empty, log "No submissions found" and exit cleanly.

Script should be runnable with: `node scripts/migrate-submissions.js`
  </action>
  <verify>
1. Run the migration: `node scripts/migrate-submissions.js`
   Expected output: "Migrated: 3, Skipped: 0, Errors: 0" (for the 3 existing submissions)
2. Run it again (idempotency check): `node scripts/migrate-submissions.js`
   Expected output: "Migrated: 0, Skipped: 3, Errors: 0"
3. Verify a migrated file: `node -e "const s = require('./data/submissions/b6df1b5e-44c0-4d38-ac2c-cc9ce58e0e85.json'); console.log('schemaVersion:', s.schemaVersion, 'dach:', s.dach, 'treppe:', s.treppe, 'decke:', s.decke);"`
   Expected: schemaVersion: 2, dach: null, treppe: null, decke: null
  </verify>
  <done>Migration script exists at scripts/migrate-submissions.js, is idempotent, and successfully adds dach:null, treppe:null, decke:null, and schemaVersion:2 to all 3 existing submissions.</done>
</task>

<task type="auto">
  <name>Task 2: Add schemaVersion to new submissions in submissionService</name>
  <files>src/services/submissionService.js</files>
  <action>
Read `src/services/submissionService.js` and find the `saveSubmission(data)` method.

In the method, before the submission object is written to disk (before `fs.writeFile` or similar), add:
```javascript
data.schemaVersion = 2;
```

This ensures every new submission created from now on has a schemaVersion field, so the migration script can distinguish already-up-to-date submissions from legacy ones.

Place this line early in the saveSubmission method, right after the ID and timestamp are assigned (if they are assigned in this method), so it's clearly part of the "prepare submission data" logic.

Do NOT change any other behavior of saveSubmission. This is a single-line addition.
  </action>
  <verify>
Run a quick test by examining the saveSubmission code path:
`node -e "const ss = require('./src/services/submissionService'); console.log(typeof ss.saveSubmission);"` — should print "function"

Then verify the source code change: `grep -n 'schemaVersion' src/services/submissionService.js` — should show the line where schemaVersion is set.
  </verify>
  <done>submissionService.saveSubmission() sets schemaVersion: 2 on all new submissions before writing to disk.</done>
</task>

</tasks>

<verification>
1. All 3 existing submissions have schemaVersion: 2, dach: null, treppe: null, decke: null
2. Running migrate script twice is safe (second run: 0 migrated, 3 skipped)
3. New submissions created via form submission include schemaVersion: 2
4. Old submissions load without errors in the result page
</verification>

<success_criteria>
- Migration script runs successfully on all 3 existing submissions
- Migration is idempotent (safe to run multiple times)
- New submissions include schemaVersion: 2
- Missing fields (dach, treppe, decke) are set to null in migrated submissions
</success_criteria>

<output>
After completion, create `.planning/phases/01-catalog-expansion/01-03-SUMMARY.md`
</output>
