---
phase: 03-pdf-design
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/services/pdf/pages/componentPage.js
  - src/services/pdf/pages/haustypPage.js
autonomous: true

must_haves:
  truths:
    - "Jede Komponentenseite zeigt das grosse Produktbild OBEN als erstes visuelles Element nach dem Header"
    - "Kein Text kommt vor dem Bild â€” die visuelle Hierarchie ist Bild, dann Ueberschrift, dann Vorteile, dann Specs"
    - "Die Haustyp-Seite zeigt das groesste Bild prominent oben mit emotionaler Ueberschrift darunter"
    - "Vorteile werden als 2-spaltige Checkmark-Liste dargestellt"
    - "Technische Details erscheinen kompakt am Ende der Seite"
  artifacts:
    - path: "src/services/pdf/pages/componentPage.js"
      provides: "Visual-first component layout: full-width image -> headline -> advantages -> specs"
      contains: "fit:"
    - path: "src/services/pdf/pages/haustypPage.js"
      provides: "Redesigned haustyp page with large hero image and emotional headline"
      contains: "cover:"
  key_links:
    - from: "src/services/pdf/pages/componentPage.js"
      to: "ctx.imageService"
      via: "getCompressedImage for full-width product images"
      pattern: "imageService\\.getCompressedImage"
    - from: "src/services/pdf/pages/componentPage.js"
      to: "src/services/pdf/layout.js"
      via: "layout.colors, layout.typography for new navy/red palette and Heading fonts"
      pattern: "layout\\.colors"
    - from: "src/services/pdf/pages/haustypPage.js"
      to: "ctx.imageService"
      via: "getCompressedImage for large haustyp hero"
      pattern: "imageService\\.getCompressedImage"
---

<objective>
Restructure component pages and the haustyp page from the current 2-column technical layout to a visual-first top-down hierarchy: large product image at top, emotional headline, advantages bullets, then compact specs.

Purpose: The requirement (PDF-02) is explicit: "kein Text kommt vor dem Bild." Every component page must lead with a large, compelling product image that immediately communicates quality. The current 2-column layout (small image left, specs right) buries the visual impact. The new layout follows magazine/brochure conventions: image dominates, text supports.

Output: Rewritten componentPage.js with full-width image-first layout, rewritten haustypPage.js with single large hero image and emotional structure.
</objective>

<execution_context>
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pdf-design/03-RESEARCH.md
@.planning/phases/03-pdf-design/03-01-SUMMARY.md
@src/services/pdf/layout.js
@src/services/pdf/pages/componentPage.js
@src/services/pdf/pages/haustypPage.js
@src/services/pdf/pages/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite componentPage.js with visual-first hierarchy</name>
  <files>src/services/pdf/pages/componentPage.js</files>
  <action>
  Completely rewrite the `renderComponent(doc, component, categoryTitle, chapterNumber, ctx)` function. The current 2-column layout (small 180x140 image left, specs right) must be replaced with a top-down visual hierarchy.

  **New layout structure (top to bottom):**

  ```
  +-----------------------------------------------+
  | [Header drawn by orchestrator: chapter + title]|  y = 95
  +-----------------------------------------------+
  |                                                |
  |        [ LARGE PRODUCT IMAGE ]                 |  y ~ 95
  |        (full content width, ~200px tall)        |
  |        (fit mode, centered)                    |
  |                                                |
  +-----------------------------------------------+  y ~ 310
  | Emotional Headline: component.name             |
  | Short description (first sentence)             |
  +-----------------------------------------------+  y ~ 360
  | Premium Features box (gold-left-border box)    |
  | 2-column checkmark list (max 4 features)       |
  +-----------------------------------------------+  y ~ 440
  | Weitere Vorteile (2-column bullet list)        |
  | (max 6 advantages)                             |
  +-----------------------------------------------+  y ~ 540
  | Technische Details (compact specs block)       |
  | Aufbau items + quality items in 2-col layout   |
  +-----------------------------------------------+  y ~ 640
  | Vergleichs-Tipp box (if space remains)         |
  +-----------------------------------------------+
  ```

  **Implementation details:**

  1. **Image section (y starts at 95):**
     - Use full content width (contentWidth = 495, marginLeft = 50)
     - Image height = 200px
     - Prefer product image (component.filePath) over technical drawing for visual impact. Fall back to technical drawing, then to drawImagePlaceholder.
     - Path resolution: `path.resolve(assetsDir, '..', component.filePath)`
     - Use `doc.image(buffer, marginLeft, y, { fit: [contentWidth, 200], align: 'center', valign: 'center' })` -- NOT cover mode, because product images should not be cropped
     - Compress via `ctx.imageService.getCompressedImage(imgPath)` (default maxWidth is fine)
     - Advance y by imgHeight + 15

  2. **Emotional headline (after image):**
     - Component name in 'Heading' font (registered Montserrat or Helvetica fallback), size 18, primary color
     - Short description (first sentence of component.description) in Helvetica, size 9, textLight color
     - Strip component name from description start to avoid repetition (existing logic -- keep it)
     - Advance y by ~40

  3. **Premium Features box (if component.premiumFeatures exists and length > 0):**
     - Keep the existing gold-left-border box style (roundedRect with goldLight fill and gold left bar)
     - "Ihre Vorteile bei Lehner Haus:" header in 'Heading-SemiBold' font, size 9, primary color
     - 2-column checkmark layout: gold checkmarks, text items
     - Max 4 features, dynamic height calculation (keep existing height calculation logic -- it works well)
     - Advance y by boxHeight + 12

  4. **Advantages list (if component.advantages and y < 620):**
     - "Weitere Vorteile:" header in 'Heading-SemiBold' font, size 9, primary color
     - 2-column bullet list with gold bullets, max 6 items
     - Keep existing 2-column layout logic
     - Advance y

  5. **Technical Details section (compact, if y < 660):**
     - A compact block combining aufbau items and quality items side by side in 2 columns
     - Left column: "Technische Daten" header + aufbau items (from layout.extractAufbauItems) -- show name and value, compact rows (12px spacing)
     - Right column: quality items (from layout.extractQualityItems) -- label and value with gold highlights
     - Use a light gray background box (grayLight) for the entire tech section
     - This replaces the old right-column aufbau list -- same data, but now at the bottom of the page
     - Gesamtstaerke (total thickness) line at the bottom of the left column if > 0

  6. **Comparison tip box (if component.comparisonNotes and y < 700):**
     - Keep existing style: gold-bordered rounded rect, "Tipp fuer den Anbietervergleich:" header
     - Constrain to remaining page space (maxHeight = 775 - y)
     - Keep existing tip extraction and truncation logic

  **IMPORTANT anti-patterns to AVOID:**
  - Do NOT put ANY text before the image. The chapter header is drawn by the orchestrator, the very next thing must be the image.
  - Do NOT use 2-column layout for image + text. Image is FULL WIDTH across the top.
  - Do NOT use `cover` mode for product images -- use `fit` to preserve aspect ratio without cropping.
  - Track y position throughout. Check `y < threshold` before each optional section to prevent overflow.

  **Font usage:**
  - Headlines: 'Heading' or 'Heading-SemiBold' (these are the registered names from 03-01, which resolve to Montserrat or Helvetica-Bold)
  - Body/details: 'Helvetica' and 'Helvetica-Bold' (keep built-in for reliability)
  </action>
  <verify>
  - `node -e "require('./src/services/pdf/pages/componentPage.js')"` -- no errors
  - Start the server, submit a configuration, open the PDF
  - Check any component page (e.g., Aussenwandsystem): the large product image should be at the TOP, immediately below the header. No text should precede the image.
  - Verify the order: image -> headline -> features/advantages -> technical details -> comparison tip
  - Verify pages with missing images show the placeholder (not a crash)
  - Verify pages with many advantages don't overflow past the footer
  </verify>
  <done>
  Every component page follows the visual hierarchy: large product image at top (full content width), emotional headline below, advantages in 2-column checkmarks, compact technical specs, and optional comparison tip. No text precedes the image on any component page.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite haustypPage.js with large hero image and emotional layout</name>
  <files>src/services/pdf/pages/haustypPage.js</files>
  <action>
  Rewrite the `renderHaustyp(doc, component, ctx)` function. The current layout shows 3 small images side-by-side. The new layout should lead with one large, impactful hero image of the house type.

  **New layout structure:**

  ```
  +-----------------------------------------------+
  | [Header drawn by orchestrator: "Ihr Haustyp"]  |  y = 95
  +-----------------------------------------------+
  |                                                |
  |        [ LARGE HERO IMAGE ]                    |  y = 95
  |        (full width, ~220px, cover mode)        |
  |        (first image: 1.png from haustyp dir)   |
  |                                                |
  +-----------------------------------------------+  y ~ 325
  | Haustyp Name (large heading, Heading font)     |
  | Description text                               |
  +-----------------------------------------------+  y ~ 400
  | +-------+  +-------+                          |
  | | img 2 |  | img 3 |  (two smaller images     |
  | |       |  |       |   side by side)           |
  | +-------+  +-------+                          |
  +-----------------------------------------------+  y ~ 520
  | Vorteile (2-column checkmarks)                 |
  +-----------------------------------------------+  y ~ 620
  | Qualitaets-Badge box                           |
  +-----------------------------------------------+
  ```

  **Implementation details:**

  1. **Large hero image (y starts at 95):**
     - Use the FIRST image (1.png) from the haustyp directory as the large hero
     - Full content width (contentWidth = 495), height = 220px
     - Use `cover` mode with clipping for full-bleed effect: `doc.save()` -> `doc.rect(marginLeft, 95, contentWidth, 220).clip()` -> `doc.image(buffer, marginLeft, 95, { cover: [contentWidth, 220], align: 'center', valign: 'center' })` -> `doc.restore()`
     - Compress via ctx.imageService.getCompressedImage(imgPath)
     - Fallback to drawImagePlaceholder if image missing
     - y = 95 + 220 + 15 = 330

  2. **Haustyp name and description:**
     - Name in 'Heading' font, size 22, primary color
     - Description in Helvetica, size 10, text color, with lineGap: 2
     - Calculate actual height of description text: `const descHeight = doc.heightOfString(desc, { width: contentWidth });`
     - y += name height (~30) + descHeight + 15

  3. **Two smaller images side by side (2.png and 3.png):**
     - Only show if y < 550 (enough space)
     - Two images, each (contentWidth - 15) / 2 wide, 130px tall
     - Use `fit` mode (not cover) for these smaller images
     - "Beispielbilder" caption below in textMuted, size 7
     - y += 130 + 18

  4. **Advantages (2-column checkmarks):**
     - "Ihre Vorteile mit diesem Haustyp:" in 'Heading-SemiBold' font, size 11, primary
     - 2-column layout with gold checkmarks (keep existing logic)
     - y advances by rows

  5. **Quality badge box (if y < 700):**
     - Keep the existing gold-bordered roundedRect with "100% individuelle Grundrissgestaltung" text
     - Use 'Heading-SemiBold' for the bold headline inside the badge
     - Keep the "Schwaebisch gut seit ueber 60 Jahren" tagline

  **Key differences from current:**
  - ONE large hero image instead of three equal images
  - The two supplementary images are smaller and appear AFTER the text
  - 'Heading' font for the haustyp name instead of Helvetica-Bold
  - Description text height is measured dynamically (not hardcoded y += 60)

  **Error handling:**
  - Wrap each image load in try/catch -- a missing image should show placeholder, not crash
  - If haustyp has no filePath, show placeholder for all three images
  - Always doc.restore() in catch blocks if doc.save() was called
  </action>
  <verify>
  - `node -e "require('./src/services/pdf/pages/haustypPage.js')"` -- no errors
  - Start the server, submit a configuration with any haustyp (e.g., Stadtvilla), open the PDF
  - The haustyp page should show: one large image at top (full width), then the name, then description, then two smaller images, then advantages, then quality badge
  - Verify the large image uses cover mode (fills the full rectangle without distortion)
  - Verify submissions with different haustyp selections all render correctly
  </verify>
  <done>
  The haustyp page leads with a single large hero image (full content width, cover mode), followed by the emotional headline, description, two supplementary images, advantages grid, and quality badge. The visual hierarchy matches the component pages: image first, text second.
  </done>
</task>

</tasks>

<verification>
1. `node -e "require('./src/services/pdf/pages/componentPage.js')"` -- no errors
2. `node -e "require('./src/services/pdf/pages/haustypPage.js')"` -- no errors
3. Generate a test PDF and verify ALL component pages follow the visual hierarchy: large image at top, headline below, advantages, specs
4. Verify the haustyp page shows one large hero image prominently
5. Verify no text appears before any product image on any page
6. Verify pages with missing/placeholder images still render correctly (no crashes)
7. Verify content does not overflow past the footer area on any page
</verification>

<success_criteria>
- Every component page shows a large product image as the FIRST element after the header -- no text precedes the image
- The visual hierarchy on every component page is: image -> headline -> advantages -> technical specs -> comparison tip
- The haustyp page leads with one large hero image instead of three equal small images
- All pages render without errors for submissions with various component selections
- Font usage: 'Heading'/'Heading-SemiBold' for headlines, Helvetica for body text
</success_criteria>

<output>
After completion, create `.planning/phases/03-pdf-design/03-02-SUMMARY.md`
</output>
