---
phase: 03-pdf-design
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/pdf/layout.js
  - src/services/pdfService.js
  - src/services/pdf/pages/titlePage.js
  - assets/fonts/Montserrat-Bold.ttf
  - assets/fonts/Montserrat-SemiBold.ttf
autonomous: true

must_haves:
  truths:
    - "Die Titelseite zeigt ein grosses Hero-Bild eines Lehner Hauses (des gewaehlten Haustyps) mit Gradient-Overlay"
    - "Corporate Branding (#003366 navy, #C8102E rot) praegt die Titelseite und das gesamte Dokument"
    - "Der personalisierte Kundenname erscheint prominent auf der Titelseite"
    - "Montserrat-Ueberschriften geben dem Dokument ein Premium-Gefuehl (Helvetica-Fallback bei Fehler)"
    - "Alle bestehenden Seiten rendern korrekt mit den neuen Farben â€” kein visueller Crash"
  artifacts:
    - path: "src/services/pdf/layout.js"
      provides: "Updated color palette (#003366/#C8102E), typography with Heading font references"
      contains: "003366"
    - path: "src/services/pdfService.js"
      provides: "Font registration with try/catch Helvetica fallback"
      contains: "registerFont"
    - path: "src/services/pdf/pages/titlePage.js"
      provides: "Hero image title page with gradient overlay and customer name"
      contains: "linearGradient"
    - path: "assets/fonts/Montserrat-Bold.ttf"
      provides: "Custom heading font file"
    - path: "assets/fonts/Montserrat-SemiBold.ttf"
      provides: "Custom heading font file (semi-bold weight)"
  key_links:
    - from: "src/services/pdfService.js"
      to: "assets/fonts/"
      via: "doc.registerFont() at document creation"
      pattern: "registerFont.*Montserrat"
    - from: "src/services/pdf/pages/titlePage.js"
      to: "ctx.imageService"
      via: "getCompressedImage for hero image"
      pattern: "imageService\\.getCompressedImage"
    - from: "src/services/pdf/pages/titlePage.js"
      to: "src/services/pdf/layout.js"
      via: "layout.colors for new navy/red palette"
      pattern: "layout\\.colors\\.primary"
---

<objective>
Update the PDF design foundation (corporate colors, custom font) and rewrite the title page as an emotional hero-image cover.

Purpose: The title page is the customer's first impression. A large lifestyle photo of their chosen house type with gradient overlay, personalized name, and premium typography transforms the PDF from a technical document into a sales-grade brochure. The color palette update cascades through all existing pages, establishing the new visual identity.

Output: Updated layout.js with navy/red palette, Montserrat font files, font registration in pdfService.js, completely rewritten titlePage.js with hero image composition.
</objective>

<execution_context>
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pdf-design/03-RESEARCH.md
@src/services/pdf/layout.js
@src/services/pdfService.js
@src/services/pdf/pages/titlePage.js
@src/services/pdf/pages/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update color palette, typography, and download Montserrat font</name>
  <files>
    src/services/pdf/layout.js
    assets/fonts/Montserrat-Bold.ttf
    assets/fonts/Montserrat-SemiBold.ttf
  </files>
  <action>
  1. Download Montserrat font files from Google Fonts. Use curl to fetch the TTF files:
     - Montserrat-Bold.ttf and Montserrat-SemiBold.ttf
     - Place in `assets/fonts/` directory (create the directory first)
     - Source: https://github.com/JulietaUla/Montserrat/raw/master/fonts/ttf/Montserrat-Bold.ttf
     - Source: https://github.com/JulietaUla/Montserrat/raw/master/fonts/ttf/Montserrat-SemiBold.ttf

  2. Update `src/services/pdf/layout.js` color palette (the ROADMAP requires #003366/#C8102E):
     - `primary`: '#003366' (navy blue, was '#06402b')
     - `primaryDark`: '#002244' (darker navy, was '#042e1f')
     - `primaryLight`: '#336699' (lighter navy, was '#267e61')
     - `secondary`: '#C8102E' (red, was '#b1a699')
     - `secondaryLight`: '#fef5f5' (light red tint, was '#f5f3ef')
     - Keep `gold`, `goldDark`, `goldLight`, `text*`, `gray*`, `white`, `error*` unchanged -- these are neutral/accent colors that work with both palettes.

  3. Update `typography` object in layout.js to reference 'Heading' for hero/h1/h2 fonts (the registered font name, which falls back to Helvetica-Bold if registration fails):
     - `hero`: change font from 'Helvetica-Bold' to 'Heading'
     - `h1`: change font from 'Helvetica-Bold' to 'Heading'
     - `h2`: change font from 'Helvetica-Bold' to 'Heading-SemiBold'
     - Keep `h3`, `body`, `small`, `caption` as Helvetica (body text stays built-in for reliability and file size)

  4. In `drawHeader()`, change the font for the title from 'Helvetica-Bold' to typography.h1.font (so it picks up 'Heading' automatically).

  5. Do NOT change drawFooter or drawImagePlaceholder -- these use Helvetica intentionally.

  IMPORTANT: The color change affects ALL 13 page modules that reference `layout.colors`. This is intentional -- the ROADMAP success criterion #4 requires consistent navy/red throughout. The existing pages will automatically pick up the new palette because they all reference `layout.colors.primary` etc.
  </action>
  <verify>
  - Verify font files exist: `ls assets/fonts/Montserrat-Bold.ttf assets/fonts/Montserrat-SemiBold.ttf`
  - Verify layout.js compiles: `node -e "require('./src/services/pdf/layout.js')"`
  - Verify color values: `grep '#003366' src/services/pdf/layout.js` returns a match
  - Verify typography references: `grep "'Heading'" src/services/pdf/layout.js` returns matches for hero and h1
  </verify>
  <done>
  layout.js has navy (#003366) primary and red (#C8102E) secondary colors. Typography hero/h1 reference 'Heading', h2 references 'Heading-SemiBold'. Montserrat TTF files exist in assets/fonts/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register fonts in pdfService and rewrite title page with hero image</name>
  <files>
    src/services/pdfService.js
    src/services/pdf/pages/titlePage.js
  </files>
  <action>
  1. In `src/services/pdfService.js`, add font registration AFTER creating the PDFDocument but BEFORE the page loop. Use try/catch with Helvetica fallback:
     ```
     const fontsDir = path.resolve(__dirname, '../assets/fonts');
     try {
       doc.registerFont('Heading', path.join(fontsDir, 'Montserrat-Bold.ttf'));
       doc.registerFont('Heading-SemiBold', path.join(fontsDir, 'Montserrat-SemiBold.ttf'));
       console.log('[PDF] Custom fonts registered: Montserrat');
     } catch (e) {
       console.warn('[PDF] Font fallback to Helvetica:', e.message);
       doc.registerFont('Heading', 'Helvetica-Bold');
       doc.registerFont('Heading-SemiBold', 'Helvetica-Bold');
     }
     ```
     Note: The path from pdfService.js to assets/ is `../../assets/fonts` (pdfService is at `src/services/pdfService.js`). Use `path.resolve(__dirname, '../../assets/fonts')`.

  2. Completely rewrite `src/services/pdf/pages/titlePage.js` for the hero image design:

     The new title page should:
     a. Keep `title: null` (no orchestrator header/footer -- title page has its own layout)
     b. Keep `condition: () => true` (always shown)
     c. The render function (async) should:

     **Hero Image (top 60% of page):**
     - Resolve the hero image dynamically: use the selected haustyp's first image as the hero
       - Get haustyp from submission: `const haustyp = ctx.catalogService.getVariantById('haustypen', submission.haustyp);`
       - Build path: if haustyp has filePath, resolve `path.resolve(assetsDir, '..', haustyp.filePath, '1.png')`
       - Fallback chain: (1) haustyp image, (2) first available haustyp dir (stadtvilla/1.png), (3) solid color background
     - Compress via ctx.imageService.getCompressedImage(heroPath, 1200) (maxWidth 1200 for full-bleed quality)
     - Draw the hero: `doc.save()` -> `doc.rect(0, 0, 595, heroHeight).clip()` -> `doc.image(buffer, 0, 0, { cover: [595, heroHeight], align: 'center', valign: 'center' })` -> `doc.restore()`
     - heroHeight = 500 (approx 60% of A4 842pt height)

     **Gradient Overlay (bottom 60% of hero area):**
     - `const grad = doc.linearGradient(0, heroHeight * 0.3, 0, heroHeight);`
     - `grad.stop(0, layout.colors.primary, 0);` (transparent at top)
     - `grad.stop(0.6, layout.colors.primary, 0.5);` (semi-transparent mid)
     - `grad.stop(1, layout.colors.primary, 0.9);` (nearly opaque at bottom)
     - `doc.rect(0, heroHeight * 0.3, 595, heroHeight * 0.7).fill(grad);`

     **Solid color fallback** (when no hero image available):
     - Instead of hero + gradient, draw `doc.rect(0, 0, 595, heroHeight).fill(layout.colors.primary);`
     - Place logo centered in the solid area at around y=100

     **Logo (small, top-left corner, on top of hero):**
     - Position the logo small in the top-left: `doc.image(logoBuffer, 40, 30, { width: 120 })` for subtle branding
     - Use existing Logo path: `path.resolve(__dirname, '..', '..', '..', '..', 'Logo', 'LehnerLogo_schwaebischgut.jpg')`
     - Compress via ctx.imageService.getCompressedImage(logoPath, 500)
     - If logo fails, skip it silently (hero image carries the visual weight)

     **Text on gradient overlay:**
     - "Ihre persoenliche" in 'Heading' font, size 26, white, positioned at heroHeight - 130, centered
     - "Leistungsbeschreibung" in 'Heading' font, size 32, gold (#D4AF37), positioned at heroHeight - 90, centered

     **Below hero area (bottom 40% of page -- navy background):**
     - Fill remaining page area: `doc.rect(0, heroHeight, 595, 842 - heroHeight).fill(layout.colors.primary);`
     - Customer name: `${anrede} ${submission.bauherr_nachname}` in 'Heading' font, size 22, white, centered, at heroHeight + 50
     - Date: formatted German date in 'Helvetica', size 10, light gray (#cccccc), centered, at heroHeight + 90
     - A decorative gold line: `doc.moveTo(200, heroHeight + 130).lineTo(395, heroHeight + 130).lineWidth(1.5).strokeColor(layout.colors.gold).stroke();`

     **Footer bar:**
     - Gold line at y=790: `doc.rect(0, 790, 595, 1.5).fill(layout.colors.gold);`
     - Footer text at y=802: "Lehner Haus GmbH . Ihr Partner fuer individuelles Bauen seit ueber 60 Jahren" in Helvetica size 8, gray

  CRITICAL PATTERNS:
  - ALWAYS use `doc.save()` before `doc.rect(...).clip()` and `doc.restore()` after drawing within the clip
  - Use try/catch around ALL image operations (hero, logo) -- title page must NEVER crash
  - Use layout.colors consistently (not hardcoded hex except for the neutral #cccccc gray)
  </action>
  <verify>
  - Verify pdfService.js compiles: `node -e "require('./src/services/pdfService.js')"`
  - Verify titlePage.js compiles: `node -e "require('./src/services/pdf/pages/titlePage.js')"`
  - Start the server (`npm start`), submit a test configuration, and verify the PDF generates without errors in the console
  - Open the generated PDF: title page should show hero image (or solid navy fallback), gradient overlay, customer name, and gold accents
  </verify>
  <done>
  pdfService.js registers Montserrat fonts with Helvetica fallback. titlePage.js renders a full-bleed hero image of the selected haustyp with gradient overlay, "Ihre persoenliche Leistungsbeschreibung" text, personalized customer name, and German date. The entire PDF uses the new navy/red corporate palette consistently.
  </done>
</task>

</tasks>

<verification>
1. `node -e "require('./src/services/pdf/layout.js')"` -- no errors
2. `node -e "require('./src/services/pdfService.js')"` -- no errors
3. `ls assets/fonts/Montserrat-Bold.ttf assets/fonts/Montserrat-SemiBold.ttf` -- both files exist
4. Generate a test PDF by running the server and submitting a configuration
5. Open the PDF and verify:
   - Title page has a large hero image (or navy fallback) covering the top ~60%
   - Gradient overlay makes text legible on the image
   - Customer name is prominently displayed
   - Navy (#003366) and gold (#D4AF37) are the dominant colors
   - All subsequent pages render correctly with the new navy/red palette (no green remnants)
</verification>

<success_criteria>
- Title page shows a large hero image of the selected haustyp with gradient overlay and personalized customer name
- The navy (#003366) and red (#C8102E) corporate colors are used throughout the entire PDF
- Montserrat headings give the document a premium feel (with graceful Helvetica fallback)
- PDF generation completes without errors for submissions with and without a haustyp selection
- All existing pages (QDF, service, component, etc.) render correctly with the updated color palette
</success_criteria>

<output>
After completion, create `.planning/phases/03-pdf-design/03-01-SUMMARY.md`
</output>
