---
phase: 02-pdf-architektur
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/services/pdf/pages/titlePage.js
  - src/services/pdf/pages/qdfCertification.js
  - src/services/pdf/pages/executiveSummary.js
  - src/services/pdf/pages/leistungsuebersicht.js
  - src/services/pdf/pages/qualityAdvantages.js
  - src/services/pdf/pages/serviceContent.js
  - src/services/pdf/pages/componentPage.js
  - src/services/pdf/pages/haustypPage.js
  - src/services/pdf/pages/floorPlan.js
  - src/services/pdf/pages/comparisonChecklist.js
  - src/services/pdf/pages/glossary.js
  - src/services/pdf/pages/beraterPage.js
  - src/services/pdf/pages/contactPage.js
  - src/services/pdf/pages/index.js
  - src/services/pdfService.js
autonomous: true

must_haves:
  truths:
    - "Each page module exports condition(submission) and render(doc, submission, ctx)"
    - "pdfService.js is an orchestrator under 50 lines that loops over page modules"
    - "PDF output is visually identical to before the extraction"
    - "Dead code methods (drawOverviewContent, drawFinalContent, drawUValueBarChart, drawSCOPGauge) are removed"
    - "Component pages are generated dynamically from a components array, not as 10 separate module files"
  artifacts:
    - path: "src/services/pdf/pages/index.js"
      provides: "buildPageList function that returns ordered array of page modules"
      exports: ["buildPageList"]
    - path: "src/services/pdf/pages/titlePage.js"
      provides: "Title page rendering (no header/footer)"
      exports: ["title", "condition", "render"]
    - path: "src/services/pdf/pages/componentPage.js"
      provides: "Shared component page renderer used by all component types"
      exports: ["renderComponent"]
    - path: "src/services/pdf/pages/haustypPage.js"
      provides: "Haustyp flyer-style page renderer"
      exports: ["renderHaustyp"]
    - path: "src/services/pdf/pages/contactPage.js"
      provides: "Contact page with QR codes (async render)"
      exports: ["title", "condition", "render"]
    - path: "src/services/pdfService.js"
      provides: "Thin orchestrator that loops over page modules"
      min_lines: 20
  key_links:
    - from: "src/services/pdfService.js"
      to: "src/services/pdf/pages/index.js"
      via: "require('./pdf/pages')"
      pattern: "require\\('./pdf/pages'\\)"
    - from: "src/services/pdf/pages/index.js"
      to: "src/services/pdf/pages/*.js"
      via: "require for each page module"
      pattern: "require\\('./\\w+Page'\\)"
    - from: "src/services/pdf/pages/componentPage.js"
      to: "src/services/pdf/layout.js"
      via: "require('../layout')"
      pattern: "require\\('\\.\\./layout'\\)"
---

<objective>
Extract all 13 page-rendering methods from pdfService.js into individual module files under `src/services/pdf/pages/`, create an index.js that builds the ordered page list with dynamic component entries, and refactor pdfService.js into a thin orchestrator (<50 lines of logic) that loops over page modules.

Purpose: After this plan, modifying any single PDF page (e.g., redesigning the title page in Phase 3) only requires editing that page's module file. No risk of coordinate drift or accidental breakage in other pages. The orchestrator is trivially simple — add/remove/reorder pages by editing the page list.

Output: 13 page module files, 1 index.js, and a refactored pdfService.js orchestrator.
</objective>

<execution_context>
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-pdf-architektur/02-RESEARCH.md
@.planning/phases/02-pdf-architektur/02-01-SUMMARY.md
@src/services/pdfService.js
@src/services/pdf/layout.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract static page modules (8 unconditional + 3 conditional pages)</name>
  <files>
    src/services/pdf/pages/titlePage.js
    src/services/pdf/pages/qdfCertification.js
    src/services/pdf/pages/executiveSummary.js
    src/services/pdf/pages/leistungsuebersicht.js
    src/services/pdf/pages/qualityAdvantages.js
    src/services/pdf/pages/serviceContent.js
    src/services/pdf/pages/floorPlan.js
    src/services/pdf/pages/comparisonChecklist.js
    src/services/pdf/pages/glossary.js
    src/services/pdf/pages/beraterPage.js
    src/services/pdf/pages/contactPage.js
    src/services/pdf/pages/componentPage.js
    src/services/pdf/pages/haustypPage.js
  </files>
  <action>
Create directory `src/services/pdf/pages/`.

Each page module follows this contract:
```javascript
const layout = require('../layout');
// + any other requires (path, fs, catalogService, QRCode)

module.exports = {
  title: 'Page Title' | null,  // null = no header/footer (title page)
  condition(submission) { return true|false; },
  render(doc, submission, ctx) { /* draw code */ }
  // render can be async if needed (contactPage)
};
```

The `ctx` object passed to render contains: `{ pageNum, catalogService }`.

Extract these page methods VERBATIM (copy the method body, replace `this.colors` → `layout.colors`, `this.typography` → `layout.typography`, `this.layout` → `layout.layout`, `this.assetsDir` → `path.resolve(__dirname, '../../../../assets')`):

**1. titlePage.js** — from `drawTitlePage` (lines 227-280)
- `title: null` (no header/footer)
- `condition: () => true`
- Needs: `path`, `fs`, `layout` for colors/typography
- Replace `path.resolve(__dirname, '..', '..', 'Logo', ...)` → adjust path relative to new file location: `path.resolve(__dirname, '..', '..', '..', '..', 'Logo', 'LehnerLogo_schwaebischgut.jpg')`

**2. qdfCertification.js** — from `drawQDFCertificationPage` (lines 310-377)
- `title: 'QDF-Zertifizierte Qualität'`
- `condition: () => true`
- Needs: `layout`

**3. executiveSummary.js** — from `drawExecutiveSummary` (lines 441-525)
- `title: 'Ihre Konfiguration auf einen Blick'`
- `condition: () => true`
- Needs: `layout`, `catalogService` (from ctx)
- Uses `layout.getGrundstueckText()`

**4. leistungsuebersicht.js** — from `drawLeistungsuebersicht` (lines 528-689)
- `title: 'Ihre Leistungen im Überblick'`
- `condition: () => true`
- Needs: `layout`, `catalogService` (from ctx)

**5. qualityAdvantages.js** — from `drawQualityAdvantagesPage` (lines 380-439)
- `title: 'Ihre 7 Qualitätsvorteile'`
- `condition: () => true`
- Needs: `layout`

**6. serviceContent.js** — from `drawServiceContent` (lines 786-824)
- `title: 'Unser Service für Sie'`
- `condition: () => true`
- Needs: `layout`

**7. floorPlan.js** — from `drawFloorPlanPage` (lines 1622-1672)
- `title: 'Ihre Raumplanung'`
- `condition: (s) => (s.rooms?.erdgeschoss?.length > 0) || (s.rooms?.obergeschoss?.length > 0) || (s.rooms?.untergeschoss?.length > 0)`
- Needs: `layout`

**8. comparisonChecklist.js** — from `drawComparisonChecklist` (lines 1452-1520)
- `title: 'Ihre Checkliste für den Anbietervergleich'`
- `condition: () => true`
- Needs: `layout`, `catalogService` (from ctx)

**9. glossary.js** — from `drawGlossaryPage` (lines 1571-1615)
- `title: 'Glossar – Fachbegriffe erklärt'`
- `condition: () => true`
- Needs: `layout`

**10. beraterPage.js** — from `drawBeraterPage` (lines 1522-1569)
- `title: 'Ihr persönlicher Fachberater'`
- `condition: (s) => !!(s.berater_name || s.berater_freitext)`
- Needs: `layout`

**11. contactPage.js** — from `drawContactPage` (lines 1412-1450) + `drawQRCode` helper (lines 1298-1319)
- `title: 'Kontakt'`
- `condition: () => true`
- **async render** (because QR code generation is async)
- Needs: `layout`, `QRCode` (require('qrcode'))
- Include `drawQRCode` as a local helper function inside this module (not exported)

**12. componentPage.js** — from `drawComponentContent` (lines 826-1047)
- NOT a standard page module (no title/condition/render exports). Instead exports:
  `module.exports = { renderComponent(doc, component, title, chapter, ctx) { ... } }`
- Needs: `layout`, `path`, `fs`
- Uses `layout.extractAufbauItems()`, `layout.extractQualityItems()`, `layout.drawImagePlaceholder()`

**13. haustypPage.js** — from `drawHaustypPage` (lines 1135-1220)
- NOT a standard page module. Instead exports:
  `module.exports = { renderHaustyp(doc, component, ctx) { ... } }`
- Needs: `layout`, `path`, `fs`
- Uses `layout.drawImagePlaceholder()`

For componentPage.js and haustypPage.js: these are renderers, not page modules. They are called from the dynamic component entries built in pages/index.js.

For every `this.assetsDir` reference, replace with the correct relative path from the new file location: `path.resolve(__dirname, '..', '..', '..', '..', 'assets')`.

CRITICAL RULES:
- Copy every coordinate, font size, color, text string VERBATIM
- Do NOT refactor, optimize, or "improve" any draw logic
- Do NOT fix the indexOf bug (CONCERNS.md item) — that is a Phase 4 task
- Do NOT change page ordering
- The only changes are: `this.colors` → `layout.colors`, `this.typography` → `layout.typography`, `this.layout` → `layout.layout`, `this.assetsDir` → computed path, `this.drawImagePlaceholder` → `layout.drawImagePlaceholder`, `this.extractAufbauItems` → `layout.extractAufbauItems`, `this.extractQualityItems` → `layout.extractQualityItems`, `this.getGrundstueckText` → `layout.getGrundstueckText`
  </action>
  <verify>
For each module file, run `node -e "const m = require('./src/services/pdf/pages/{filename}'); console.log(Object.keys(m));"` and verify it exports the expected keys without error.
  </verify>
  <done>All 13 page module files exist under src/services/pdf/pages/, each importing layout and exporting the correct interface. No `this.*` references remain in any page module.</done>
</task>

<task type="auto">
  <name>Task 2: Create pages/index.js and refactor pdfService.js orchestrator</name>
  <files>
    src/services/pdf/pages/index.js
    src/services/pdfService.js
  </files>
  <action>
**Part A: Create `src/services/pdf/pages/index.js`**

This file exports a `buildPageList(submission)` function that returns an ordered array of page entries. Each entry is `{ title, condition, render }`.

Structure:
```javascript
const catalogService = require('../../catalogService');
const titlePage = require('./titlePage');
const qdfCertification = require('./qdfCertification');
const executiveSummary = require('./executiveSummary');
const leistungsuebersicht = require('./leistungsuebersicht');
const qualityAdvantages = require('./qualityAdvantages');
const serviceContent = require('./serviceContent');
const { renderComponent } = require('./componentPage');
const { renderHaustyp } = require('./haustypPage');
const floorPlan = require('./floorPlan');
const comparisonChecklist = require('./comparisonChecklist');
const glossary = require('./glossary');
const beraterPage = require('./beraterPage');
const contactPage = require('./contactPage');

function buildPageList(submission) {
  const pages = [
    titlePage,
    qdfCertification,
    executiveSummary,
    leistungsuebersicht,
    qualityAdvantages,
    serviceContent,
  ];

  // Dynamic component pages (same order as current generatePDF)
  const components = [
    { title: 'Ihr Haustyp', data: catalogService.getVariantById('haustypen', submission.haustyp), chapter: '5.1', isHaustyp: true },
    { title: 'Außenwandsystem', data: catalogService.getVariantById('walls', submission.wall), chapter: '5.2' },
    { title: 'Innenwandsystem', data: catalogService.getVariantById('innerwalls', submission.innerwall), chapter: '5.3' },
    { title: 'Deckensystem', data: catalogService.getVariantById('decken', submission.decke), chapter: '5.4' },
    { title: 'Fenstersystem', data: catalogService.getVariantById('windows', submission.window), chapter: '5.5' },
    { title: 'Dacheindeckung', data: catalogService.getVariantById('tiles', submission.tiles), chapter: '5.6' },
    { title: 'Dachform', data: catalogService.getVariantById('daecher', submission.dach), chapter: '5.7' },
    { title: 'Heizungssystem', data: catalogService.getVariantById('heizung', submission.heizung), chapter: '6.1' },
  ];

  // Treppe (conditional)
  if (submission.treppe && submission.treppe !== 'keine') {
    const treppe = catalogService.getVariantById('treppen', submission.treppe);
    if (treppe && treppe.id !== 'keine') {
      components.push({ title: 'Treppensystem', data: treppe, chapter: '5.8' });
    }
  }

  // Lüftung (conditional)
  if (submission.lueftung && submission.lueftung !== 'keine') {
    const lueftung = catalogService.getVariantById('lueftung', submission.lueftung);
    if (lueftung && lueftung.id !== 'keine') {
      components.push({ title: 'Lüftungssystem', data: lueftung, chapter: '6.2' });
    }
  }

  // Convert component data into page entries
  for (const comp of components) {
    if (!comp.data) continue;
    pages.push({
      title: comp.title,
      condition: () => true,
      render: (doc, submission, ctx) => {
        if (comp.isHaustyp) {
          return renderHaustyp(doc, comp.data, ctx);
        } else {
          return renderComponent(doc, comp.data, comp.title, comp.chapter, ctx);
        }
      }
    });
  }

  // Post-component pages
  pages.push(floorPlan);
  pages.push(comparisonChecklist);
  pages.push(glossary);
  pages.push(beraterPage);
  pages.push(contactPage);

  return pages;
}

module.exports = { buildPageList };
```

Preserve the existing console.log statements for component page skipping — add them inside the component loop where `comp.data` is null.

**Part B: Refactor pdfService.js into thin orchestrator**

Replace the entire pdfService.js file with a thin orchestrator:

```javascript
const PDFDocument = require('pdfkit');
const fs = require('fs');
const path = require('path');
const layout = require('./pdf/layout');
const { buildPageList } = require('./pdf/pages');
const catalogService = require('./catalogService');

class PdfService {
  constructor() {
    this.outputDir = path.join(__dirname, '../../output');
  }

  async ensureOutputDir() {
    if (!fs.existsSync(this.outputDir)) {
      fs.mkdirSync(this.outputDir, { recursive: true });
    }
  }

  async generatePDF(submission) {
    await this.ensureOutputDir();
    const outputPath = path.join(this.outputDir, `Leistungsbeschreibung_${submission.id}.pdf`);

    const doc = new PDFDocument({ size: 'A4', margin: 0, autoFirstPage: false, bufferPages: false });
    const stream = fs.createWriteStream(outputPath);
    doc.pipe(stream);

    const pages = buildPageList(submission);
    let pageNum = 0;
    const ctx = { pageNum: 0, catalogService };

    for (const page of pages) {
      if (!page.condition(submission)) continue;
      doc.addPage();
      pageNum++;
      ctx.pageNum = pageNum;
      if (page.title) layout.drawHeader(doc, page.title);
      await page.render(doc, submission, ctx);
      if (page.title) layout.drawFooter(doc, pageNum);
    }

    doc.end();

    return new Promise((resolve, reject) => {
      stream.on('finish', () => resolve(outputPath));
      stream.on('error', reject);
    });
  }
}

module.exports = new PdfService();
```

Note: The title page has `title: null`, so drawHeader and drawFooter are NOT called for it. The title page handles its own layout (no standard header/footer). This matches the current behavior exactly (line 83-84: `doc.addPage(); this.drawTitlePage(doc, submission);` — no drawHeader/drawFooter).

Note: pageNum starts at 0 in the orchestrator, incremented before each page. The title page gets pageNum=1 but since it has title=null, no footer is drawn. The first page that gets a footer (QDF) gets pageNum=2. This matches the current behavior (line 80: `let pageNum = 1;`, then `pageNum++` before QDF page = 2).

**Dead code removal:** The following methods from the old pdfService.js are NOT extracted and are intentionally deleted:
- `drawOverviewContent` (lines 691-784) — dead code, never called from generatePDF
- `drawFinalContent` (lines 1321-1410) — dead code, superseded by drawContactPage
- `drawUValueBarChart` (lines 1223-1257) — dead code, never wired
- `drawSCOPGauge` (lines 1260-1295) — dead code, never wired

CRITICAL: The orchestrator's page loop uses `await page.render(...)` for every page. This is essential because `contactPage.render` is async (QR code generation). For synchronous pages, `await` on a non-promise is a no-op.
  </action>
  <verify>
1. Run `node -e "const pdf = require('./src/services/pdfService'); console.log('Orchestrator loaded OK');"` — must succeed.
2. Count lines in pdfService.js: `wc -l src/services/pdfService.js` — must be under 50 lines.
3. Run `node -e "const { buildPageList } = require('./src/services/pdf/pages'); const pages = buildPageList({ haustyp: 'stadtvilla', wall: 'climativ', innerwall: 'fermacell-standard', window: 'kunststoff-fenster', tiles: 'ton-ziegel', heizung: 'vaillant-arotherm', dach: 'satteldach', decke: 'brettstapeldecke' }); console.log('Pages:', pages.length); pages.forEach(p => console.log('-', p.title || '(title page)'));"` — must list all pages in correct order.
4. Start server and generate a PDF. Compare file size to pre-refactoring baseline (within 1 KB). Visually spot-check title page, one component page, contact page.
  </verify>
  <done>pdfService.js is under 50 lines. All pages render from individual modules. buildPageList returns correct page order. PDF output is visually identical. Dead code is removed. No `this.draw*` methods remain in pdfService.js.</done>
</task>

</tasks>

<verification>
1. `wc -l src/services/pdfService.js` shows fewer than 50 lines
2. `ls src/services/pdf/pages/` shows 14 files (13 page modules + index.js)
3. `node -e "require('./src/services/pdfService')"` loads without error
4. Each page module loads without error
5. Generated PDF is visually identical to pre-refactoring baseline
6. `grep -r "drawOverviewContent\|drawFinalContent\|drawUValueBarChart\|drawSCOPGauge" src/services/` returns 0 matches (dead code removed)
7. `grep -rn "this\.draw" src/services/pdfService.js` returns 0 matches
</verification>

<success_criteria>
- pdfService.js is a thin orchestrator under 50 lines
- 13 page modules exist under src/services/pdf/pages/, each with condition + render exports (except componentPage and haustypPage which export renderer functions)
- pages/index.js exports buildPageList that returns correct page order
- Dead code (4 methods) is removed
- PDF generation produces identical visual output
</success_criteria>

<output>
After completion, create `.planning/phases/02-pdf-architektur/02-02-SUMMARY.md`
</output>
