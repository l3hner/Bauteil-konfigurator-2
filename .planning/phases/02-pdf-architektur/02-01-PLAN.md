---
phase: 02-pdf-architektur
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/pdf/layout.js
  - src/services/pdfService.js
autonomous: true

must_haves:
  truths:
    - "pdfService.js references layout.colors, layout.typography, layout.layout instead of this.colors, this.typography, this.layout"
    - "layout.js exports colors, typography, layout, drawHeader, drawFooter, drawImagePlaceholder, extractAufbauItems, extractQualityItems, getGrundstueckText"
    - "Generating a PDF produces visually identical output to before the extraction (same file size within 1 KB)"
  artifacts:
    - path: "src/services/pdf/layout.js"
      provides: "Shared brand constants and draw helpers for all PDF pages"
      exports: ["colors", "typography", "layout", "drawHeader", "drawFooter", "drawImagePlaceholder", "extractAufbauItems", "extractQualityItems", "getGrundstueckText"]
  key_links:
    - from: "src/services/pdfService.js"
      to: "src/services/pdf/layout.js"
      via: "require('./pdf/layout')"
      pattern: "require\\('./pdf/layout'\\)"
---

<objective>
Extract all shared brand constants (colors, typography, layout dimensions) and reusable draw helpers (drawHeader, drawFooter, drawImagePlaceholder, extractAufbauItems, extractQualityItems, getGrundstueckText) from pdfService.js into a new `src/services/pdf/layout.js` module. Then update all references in pdfService.js from `this.*` to `layout.*`.

Purpose: This is the prerequisite for Plan 02-02 (page extraction). Without layout.js, extracted page modules cannot access brand constants and shared helpers. Extracting layout first means every subsequent page module only needs `require('../layout')` to access the design system.

Output: `src/services/pdf/layout.js` with all shared constants and helpers. pdfService.js updated to import and use layout module instead of instance properties.
</objective>

<execution_context>
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-pdf-architektur/02-RESEARCH.md
@src/services/pdfService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create layout.js with shared constants and draw helpers</name>
  <files>src/services/pdf/layout.js</files>
  <action>
Create directory `src/services/pdf/` and file `src/services/pdf/layout.js`.

Copy these VERBATIM from pdfService.js (zero logic changes):

1. **colors object** (lines 13-30): The entire `this.colors = { ... }` block. Export as `const colors = { ... }`.

2. **typography object** (lines 36-44): The entire `this.typography = { ... }` block. Export as `const typography = { ... }`.

3. **layout object** (lines 46-56): The entire `this.layout = { ... }` block. Export as `const layout = { ... }`.

4. **drawHeader function** (lines 282-290): Convert from class method to standalone function `function drawHeader(doc, title)`. Replace `this.colors.gold` with `colors.gold`, `this.colors.primary` with `colors.primary`, `this.colors.secondary` with `colors.secondary`.

5. **drawFooter function** (lines 292-307): Convert from class method to standalone function `function drawFooter(doc, pageNum)`. Replace all `this.colors.*` with `colors.*`.

6. **drawImagePlaceholder function** (lines 1674-1697): Convert from class method to standalone function `function drawImagePlaceholder(doc, x, y, width, height, category)`. No `this.*` references to replace (this method uses local color map).

7. **extractAufbauItems function** (lines 1049-1102): Convert from class method to standalone function `function extractAufbauItems(component, categoryTitle)`. No `this.*` references.

8. **extractQualityItems function** (lines 1104-1132): Convert from class method to standalone function `function extractQualityItems(component, categoryTitle)`. No `this.*` references.

9. **getGrundstueckText function** (lines 1617-1620): Convert from class method to standalone function `function getGrundstueckText(status)`. No `this.*` references.

Add `const path = require('path');` and `const fs = require('fs');` at the top (needed by drawImagePlaceholder and potentially by page modules that import layout).

Export all: `module.exports = { colors, typography, layout, drawHeader, drawFooter, drawImagePlaceholder, extractAufbauItems, extractQualityItems, getGrundstueckText };`

CRITICAL: Copy every coordinate, font size, color hex value, and string VERBATIM. Do not "improve" or "clean up" any values.
  </action>
  <verify>
Run `node -e "const l = require('./src/services/pdf/layout'); console.log(Object.keys(l)); console.log('colors:', Object.keys(l.colors).length, 'keys'); console.log('typography:', Object.keys(l.typography).length, 'keys'); console.log('layout:', Object.keys(l.layout).length, 'keys');"` from project root. Expect: colors (16 keys), typography (7 keys), layout (8 keys), plus 6 functions.
  </verify>
  <done>layout.js exists, exports 9 named exports (3 objects + 6 functions), all values match pdfService.js originals exactly.</done>
</task>

<task type="auto">
  <name>Task 2: Update pdfService.js to use layout module</name>
  <files>src/services/pdfService.js</files>
  <action>
Update pdfService.js to import and use the layout module instead of instance properties:

1. **Add import** at top (after existing requires): `const layout = require('./pdf/layout');`

2. **Remove constructor properties**: Delete the `this.colors = { ... }`, `this.hasCustomFonts = false`, `this.typography = { ... }`, and `this.layout = { ... }` blocks from the constructor. Keep `this.outputDir` and `this.assetsDir`.

3. **Replace all `this.colors.*`** with `layout.colors.*` throughout the entire file. Use find-replace, not manual edits. This affects every draw method.

4. **Replace all `this.typography.*`** with `layout.typography.*` throughout the entire file.

5. **Replace all `this.layout.*`** with `layout.layout.*` throughout the entire file.

6. **Replace `this.drawHeader(` calls** in generatePDF with `layout.drawHeader(`. There are approximately 12 calls.

7. **Replace `this.drawFooter(` calls** in generatePDF with `layout.drawFooter(`. There are approximately 12 calls.

8. **Replace `this.drawImagePlaceholder(` calls** with `layout.drawImagePlaceholder(`. There are calls in drawComponentContent and drawHaustypPage.

9. **Replace `this.extractAufbauItems(` calls** with `layout.extractAufbauItems(`. Called in drawComponentContent.

10. **Replace `this.extractQualityItems(` calls** with `layout.extractQualityItems(`. Called in drawComponentContent.

11. **Replace `this.getGrundstueckText(` calls** with `layout.getGrundstueckText(`. Called in drawExecutiveSummary.

12. **Delete the original method bodies** for drawHeader, drawFooter, drawImagePlaceholder, extractAufbauItems, extractQualityItems, getGrundstueckText from the class (they now live in layout.js).

Do NOT change any other draw method bodies. Do NOT remove or modify drawTitlePage, drawQDFCertificationPage, drawExecutiveSummary, drawLeistungsuebersicht, drawQualityAdvantagesPage, drawServiceContent, drawComponentContent, drawHaustypPage, drawContactPage, drawQRCode, drawFloorPlanPage, drawComparisonChecklist, drawGlossaryPage, drawBeraterPage. These remain as class methods for now (extracted in Plan 02-02).

Also do NOT remove the dead code methods yet (drawOverviewContent, drawFinalContent, drawUValueBarChart, drawSCOPGauge) — they will be removed in Plan 02-02.

CRITICAL: After all replacements, verify no `this.colors`, `this.typography`, `this.layout`, `this.drawHeader`, `this.drawFooter`, `this.drawImagePlaceholder`, `this.extractAufbauItems`, `this.extractQualityItems`, or `this.getGrundstueckText` references remain. The only `this.*` references should be `this.outputDir`, `this.assetsDir`, `this.hasCustomFonts`, and calls to remaining draw methods (`this.drawTitlePage`, etc.).
  </action>
  <verify>
1. Run `node -e "const pdf = require('./src/services/pdfService'); console.log('PdfService loaded OK');"` — must not throw.
2. Search for stale references: `grep -n "this\.colors\|this\.typography\|this\.layout\b" src/services/pdfService.js` — should return zero matches (except `this.layout` as part of other property names if any).
3. Generate a test PDF by starting the server (`npm start`) and submitting a configuration. Compare visually to a pre-refactoring PDF. File sizes should be within 1 KB of each other.
  </verify>
  <done>pdfService.js imports layout module. All shared constants and helpers are consumed from layout.js. No `this.colors/typography/layout` references remain. PDF output is visually identical to before.</done>
</task>

</tasks>

<verification>
1. `node -e "require('./src/services/pdf/layout')"` loads without error
2. `node -e "require('./src/services/pdfService')"` loads without error
3. No `this.colors`, `this.typography`, `this.layout` in pdfService.js (grep returns 0 matches)
4. Generated PDF file size is within 1 KB of pre-refactoring baseline
5. Visual spot-check: title page, one component page, and contact page look identical
</verification>

<success_criteria>
- layout.js exists with 9 exports (colors, typography, layout, drawHeader, drawFooter, drawImagePlaceholder, extractAufbauItems, extractQualityItems, getGrundstueckText)
- pdfService.js uses `layout.*` for all shared constants and helpers
- PDF generation produces identical output
</success_criteria>

<output>
After completion, create `.planning/phases/02-pdf-architektur/02-01-SUMMARY.md`
</output>
