---
phase: 04-pdf-inhalte-und-bugs
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/imageService.js
autonomous: true

must_haves:
  truths:
    - "Ein generiertes PDF mit allen Komponenten und Produktbildern ist unter 5 MB gross"
    - "Bilder mit Alpha-Kanal werden auf weissem Hintergrund geflattened und als JPEG komprimiert"
    - "Kleine Bilder unter 10 KB werden weiterhin uebersprungen"
  artifacts:
    - path: "src/services/imageService.js"
      provides: "Image compression with alpha flattening and reduced maxWidth"
      contains: "flatten"
  key_links:
    - from: "src/services/imageService.js"
      to: "sharp"
      via: "flatten({background: '#ffffff'}) before JPEG conversion"
      pattern: "flatten.*ffffff"
---

<objective>
Tune image compression to bring PDF file size under 5 MB by flattening alpha channels and reducing maxWidth.

Purpose: The current PDF is 5.8 MB (down from 23 MB after Phase 2 compression work). The remaining bloat comes from 3 large images with alpha channels that stay as PNG instead of being converted to the much smaller JPEG format. Flattening these to white background enables JPEG compression, and reducing maxWidth from 800 to 600 provides additional savings. This fulfills requirement INH-04.

Output: imageService.js with alpha flattening and reduced maxWidth default, producing PDFs under 5 MB.
</objective>

<execution_context>
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/services/imageService.js
@.planning/phases/04-pdf-inhalte-und-bugs/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Flatten alpha channels and reduce maxWidth in imageService.js</name>
  <files>src/services/imageService.js</files>
  <action>
Modify `src/services/imageService.js` with two changes:

**Change 1: Reduce default maxWidth from 800 to 600**

Update the function signature:
```javascript
async function getCompressedImage(imagePath, maxWidth = 600) {
```

Rationale: At 72 DPI, the PDF content width is 475pt = ~475px. At 600px maxWidth, images are still slightly oversampled (1.26x), which is sufficient for print quality on A4. The previous 800px was 4x oversampling at 72 DPI which was overkill.

**Change 2: Flatten alpha channels to white before JPEG conversion**

Replace the current alpha-handling block (lines 40-46):
```javascript
if (metadata.hasAlpha) {
  // Keep PNG for images with transparency (technical drawings)
  pipeline = pipeline.png({ compressionLevel: 8 });
} else {
  // Convert to JPEG for photos (much smaller)
  pipeline = pipeline.jpeg({ quality: 75, mozjpeg: true });
}
```

With:
```javascript
if (metadata.hasAlpha) {
  // Flatten transparency to white (PDF renders on white pages anyway)
  // then compress as JPEG for much smaller file size
  pipeline = pipeline.flatten({ background: '#ffffff' })
    .jpeg({ quality: 75, mozjpeg: true });
} else {
  // Convert to JPEG for photos (much smaller)
  pipeline = pipeline.jpeg({ quality: 75, mozjpeg: true });
}
```

Rationale: All images in this project are rendered on white PDF pages. No image genuinely needs transparency in the final PDF. The 3 large alpha images (vollholzdecke-technical.png at 2.8 MB, lehner-decke-technical.png at 632 KB, dezentral-technical.png at 590 KB) were staying as PNG and retaining most of their original size. Flattening to white and converting to JPEG will reduce these by 5-10x.

Update the log message to indicate flatten was applied when alpha was detected (optional but helpful for debugging):
```javascript
const wasFlattened = metadata.hasAlpha ? ' (alpha flattened)' : '';
console.log(`[Image] Compressed ${path.basename(imagePath)}: ${(stats.size / 1024).toFixed(0)} KB -> ${(buffer.length / 1024).toFixed(0)} KB (${reduction}% reduction${wasFlattened})`);
```

Do NOT change: the 10 KB skip threshold, the caching logic, the error fallback behavior, or the clearCache function. Keep JPEG quality at 75 (research confirmed this is sufficient).
  </action>
  <verify>
Generate a PDF with all components selected and measure file size:
```bash
# After starting server and submitting a full configuration:
ls -la output/*.pdf | tail -1
# File size should be under 5 MB (5,242,880 bytes)
```
Also check the console output for "[Image] Compressed" lines to verify alpha images are being flattened and compressed significantly (the 3 large alpha images should show 80%+ reduction).
  </verify>
  <done>
imageService.js flattens alpha channels to white before JPEG conversion, uses maxWidth=600 as default, and generated PDFs with full component selection are under 5 MB.
  </done>
</task>

</tasks>

<verification>
1. `node -e "require('./src/services/imageService')"` loads without error
2. Generate a full PDF (all components, all images) and verify file size < 5 MB
3. Console shows "[Image] Compressed ... (alpha flattened)" for images that had alpha
4. Small placeholder images (< 10 KB) are still skipped (no regression)
5. Visual quality of images in the PDF is acceptable (no visible JPEG artifacts at normal viewing)
</verification>

<success_criteria>
- imageService.js uses maxWidth=600 default
- Alpha images are flattened to white and converted to JPEG
- Generated PDF with all components is under 5 MB
- No regression in image loading, caching, or error handling
</success_criteria>

<output>
After completion, create `.planning/phases/04-pdf-inhalte-und-bugs/04-03-SUMMARY.md`
</output>
