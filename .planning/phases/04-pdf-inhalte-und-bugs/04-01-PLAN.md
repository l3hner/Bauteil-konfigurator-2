---
phase: 04-pdf-inhalte-und-bugs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/pdf/pages/eigenleistungen.js
  - src/services/pdf/pages/index.js
  - src/services/pdf/pages/floorPlan.js
autonomous: true

must_haves:
  truths:
    - "Eigenleistungen-Seite erscheint in der PDF wenn Eigenleistungen erfasst wurden"
    - "Eigenleistungen-Seite erscheint NICHT wenn keine Eigenleistungen erfasst wurden (leeres Array)"
    - "Raumplanung-Seite rendert korrekt auch bei vielen Raeumen ohne Seitenueberfluss"
  artifacts:
    - path: "src/services/pdf/pages/eigenleistungen.js"
      provides: "Eigenleistungen page module rendering user self-performed work items"
      exports: ["title", "condition", "render"]
    - path: "src/services/pdf/pages/index.js"
      provides: "Page list registration including eigenleistungen"
      contains: "eigenleistungen"
    - path: "src/services/pdf/pages/floorPlan.js"
      provides: "Floor plan page with y-overflow protection"
      contains: "y > 7"
  key_links:
    - from: "src/services/pdf/pages/eigenleistungen.js"
      to: "submission.eigenleistungen"
      via: "condition checks length > 0, render iterates array"
      pattern: "submission\\.eigenleistungen"
    - from: "src/services/pdf/pages/index.js"
      to: "src/services/pdf/pages/eigenleistungen.js"
      via: "require and push into pages array"
      pattern: "require.*eigenleistungen"
---

<objective>
Create the missing Eigenleistungen PDF page module and harden Raumplanung against overflow.

Purpose: Submissions with Eigenleistungen currently produce no page in the PDF -- the module was never created during Phase 2 refactoring. The data pipeline works (form -> parser -> JSON), but nothing renders it. Additionally, floorPlan.js has no y-overflow guard for edge cases with many rooms.

Output: Working eigenleistungen.js page module registered in the page list, and floorPlan.js with overflow protection.
</objective>

<execution_context>
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LehnerJ.LEHNER-HAUS/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/services/pdf/pages/index.js
@src/services/pdf/pages/floorPlan.js
@src/services/pdf/layout.js
@src/services/submissionService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Eigenleistungen page module and register in page list</name>
  <files>
    src/services/pdf/pages/eigenleistungen.js
    src/services/pdf/pages/index.js
  </files>
  <action>
Create `src/services/pdf/pages/eigenleistungen.js` following the page module contract (title, condition, render):

- **title**: `'Ihre geplanten Eigenleistungen'`
- **condition**: `submission.eigenleistungen && submission.eigenleistungen.length > 0` -- CRITICAL: empty array `[]` is truthy, must check `.length > 0`
- **render(doc, submission, ctx)**:
  - Use `layout.colors`, `layout.layout.marginLeft` (60), `layout.layout.contentWidth` (475) from `require('../layout')`
  - Start at y = 100 (below header drawn by orchestrator)
  - Intro paragraph: "Folgende Arbeiten moechten Sie in Eigenleistung durchfuehren:" in Helvetica 10pt, textLight color
  - Bulleted list of each eigenleistung item:
    - Gold bullet (layout.colors.gold), item text in Helvetica-Bold 10pt, layout.colors.text
    - 18px line height per item
    - y-overflow guard: skip items if `y > 720` (leave room for hint box + footer)
  - After list, add a Hinweis box (gold-accent style matching floorPlan pattern):
    - Only render if `y < 700` (enough space remaining)
    - `roundedRect` with `layout.colors.goldLight` fill, 4px gold left accent bar
    - Text: "Hinweis: Die genannten Eigenleistungen werden bei der Angebotserstellung beruecksichtigt. Ihr Fachberater bespricht gerne die Details mit Ihnen." in Helvetica 9pt

Register in `src/services/pdf/pages/index.js`:
- Add `const eigenleistungen = require('./eigenleistungen');` at the top with other requires
- In `buildPageList()`, add `pages.push(eigenleistungen);` AFTER `pages.push(floorPlan)` and BEFORE `pages.push(comparisonChecklist)` (line 82 area)
  </action>
  <verify>
After creating the module, verify the condition logic directly:

```bash
node -e "const p = require('./src/services/pdf/pages/eigenleistungen'); console.log('empty:', p.condition({eigenleistungen: []})); console.log('populated:', p.condition({eigenleistungen: ['Malerarbeiten']})); console.log('missing:', p.condition({})); console.log('undefined:', p.condition({eigenleistungen: undefined}));"
```

Expected output:
- empty: false
- populated: true
- missing: false
- undefined: false

Then start server with `npm start`, submit a configuration with Eigenleistungen entries (e.g., "Malerarbeiten", "Bodenbelaege verlegen"), generate PDF, and confirm the Eigenleistungen page appears between Raumplanung and Vergleichscheckliste. Also submit without Eigenleistungen and confirm no empty page appears.
  </verify>
  <done>
Eigenleistungen page renders in PDF when eigenleistungen array has items; page does not appear when array is empty or field is missing. Condition logic verified programmatically for all edge cases (empty array, populated array, missing field, undefined).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add y-overflow protection to floorPlan.js</name>
  <files>src/services/pdf/pages/floorPlan.js</files>
  <action>
Add y-position overflow guards to `floorPlan.js` to prevent content from overlapping the footer (which starts at y=800):

1. **Before each floor header** (the `roundedRect` at y): Add check `if (y > 720) return;` inside the `floors.forEach` callback. This prevents rendering a floor header with no room for rooms below it.

2. **Before each room item** in the inner `floor.rooms.forEach`: Add check `if (y > 740) return;` -- leaves space for the room text line but stops before the footer zone.

3. **Before the Hinweis box** at the bottom: Change the unconditional render to check `if (y + 60 < 780)` before drawing the hint box. Currently the hint box renders at a fixed offset regardless of how much content preceded it.

Do NOT change any existing visual styling, text, colors, or layout constants. Only add the overflow guards.
  </action>
  <verify>
Visually inspect floorPlan.js code to confirm guards are present. The page should degrade gracefully by truncating rather than overlapping the footer.
  </verify>
  <done>
floorPlan.js has y-overflow guards before floor headers (y > 720), room items (y > 740), and hint box (y + 60 < 780). No visual regression for normal-length room lists.
  </done>
</task>

</tasks>

<verification>
1. Generate a PDF with eigenleistungen data -- eigenleistungen page appears with correct content
2. Generate a PDF without eigenleistungen -- no empty eigenleistungen page
3. The page order is: ...component pages -> Raumplanung -> Eigenleistungen -> Vergleichscheckliste -> ...
4. FloorPlan page does not overflow past y=780 even with many rooms
</verification>

<success_criteria>
- eigenleistungen.js exists and exports { title, condition, render }
- condition returns false for empty array and missing field (verified via node -e)
- Page is registered in buildPageList between floorPlan and comparisonChecklist
- floorPlan.js has 3 y-overflow guards (floor header, room item, hint box)
- No regression in existing PDF pages
</success_criteria>

<output>
After completion, create `.planning/phases/04-pdf-inhalte-und-bugs/04-01-SUMMARY.md`
</output>
